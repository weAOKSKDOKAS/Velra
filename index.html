<!doctype html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>VELRA Terminal</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=Fraunces:opsz,ital,wght@9..144,0,600;9..144,0,700;9..144,0,800;9..144,1,600;9..144,1,700;9..144,1,800&family=JetBrains+Mono:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#09090b;
      --bg2:#0c0c0f;
      --card:#111113;
      --card2:#161618;
      --line:rgba(255,255,255,.06);
      --line2:rgba(255,255,255,.04);
      --txt:rgba(255,255,255,.92);
      --sub:rgba(255,255,255,.55);
      --muted:rgba(255,255,255,.35);
      --muted2:rgba(255,255,255,.22);
      --gold:#c8a951;
      --gold2:#b89a42;
      --goldDim:rgba(200,169,81,.15);
      --green:#22c55e;
      --red:#ef4444;
      --mono:'JetBrains Mono', 'SF Mono', 'Fira Code', monospace;
    }
    *{box-sizing:border-box;}
    html,body{height:100%;margin:0;}
    body{
      background:var(--bg);
      color:var(--txt);
      font-family:Inter, system-ui, -apple-system, sans-serif;
      letter-spacing:.01em;
      font-size:13px;
      -webkit-font-smoothing:antialiased;
    }
    .serifTitle{font-family:Fraunces, Georgia, serif;font-style:italic;letter-spacing:-.02em;}
    .mono{font-family:var(--mono);}

    .card{background:var(--card);border:1px solid var(--line);border-radius:3px;}

    /* ---- Top bar ---- */
    .topBar{
      background:var(--bg);
      border-bottom:1px solid var(--line);
      padding:.45rem 1.5rem;
      display:flex;align-items:center;justify-content:space-between;
    }
    .topBar .brand{
      font-family:var(--mono);font-weight:800;font-size:.78rem;
      letter-spacing:.25em;color:var(--gold);
    }
    .topBar .brand span{color:rgba(255,255,255,.45);font-weight:600;}

    /* ---- Region bar ---- */
    .regionBar{
      background:rgba(255,255,255,.015);
      border-bottom:1px solid var(--line);
      padding:.45rem 1.5rem;
      display:flex;align-items:center;justify-content:space-between;
    }
    .regionPath{
      font-family:var(--mono);font-weight:700;font-size:.68rem;
      letter-spacing:.18em;color:var(--muted);
    }
    .regionPath .active{color:var(--gold);}

    /* ---- Ticker ---- */
    .breakingWrap{border-bottom:1px solid var(--line);background:var(--bg);overflow:hidden;}
    .breakingInner{
      display:flex;gap:.8rem;align-items:center;
      white-space:nowrap;will-change:transform;
      animation:ticker 120s linear infinite;
      padding:.35rem 0;
    }
    .breakingInner:hover{animation-play-state:paused;}
    @keyframes ticker{0%{transform:translateX(0);}100%{transform:translateX(-50%);}}
    .breakingBadge{
      margin-left:.8rem;padding:.15rem .5rem;border-radius:2px;
      background:rgba(200,169,81,.08);border:1px solid rgba(200,169,81,.2);
      color:var(--gold);font-family:var(--mono);
      font-weight:800;letter-spacing:.14em;font-size:.55rem;flex:0 0 auto;
    }
    .tickItem{color:var(--sub);font-weight:500;font-size:.72rem;padding-right:1.2rem;border-right:1px solid var(--line);}
    .tickTime{color:var(--gold);font-weight:700;margin-right:.3rem;font-family:var(--mono);font-size:.62rem;}

    /* ---- Nav ---- */
    .navBox{background:var(--card);border:1px solid var(--line);border-radius:3px;overflow:hidden;}
    .navTitle{
      padding:.6rem .75rem;font-family:var(--mono);font-size:.58rem;
      letter-spacing:.18em;font-weight:700;color:var(--gold);
      display:flex;gap:.35rem;align-items:center;
      border-bottom:1px solid var(--line);
    }
    .navItem{
      width:100%;text-align:left;padding:.5rem .75rem;
      border-bottom:1px solid rgba(255,255,255,.03);
      color:var(--sub);font-family:var(--mono);font-weight:600;
      font-size:.68rem;letter-spacing:.06em;transition:all .1s;
      display:flex;align-items:center;justify-content:space-between;
    }
    .navItem:hover{background:rgba(255,255,255,.025);color:rgba(255,255,255,.75);}
    .navItem.active{background:rgba(200,169,81,.06);color:var(--gold);border-left:2px solid var(--gold);font-weight:700;}
    .dot{width:4px;height:4px;border-radius:50%;background:var(--gold);}
    .statusDot{width:5px;height:5px;border-radius:50%;background:var(--green);display:inline-block;}

    /* ---- Buttons ---- */
    .btnGhost{
      font-family:var(--mono);border:1px solid rgba(255,255,255,.08);
      background:transparent;color:var(--sub);
      font-weight:700;padding:.25rem .5rem;border-radius:2px;
      font-size:.6rem;letter-spacing:.08em;transition:all .1s;
    }
    .btnGhost:hover{border-color:rgba(200,169,81,.25);color:var(--gold);}
    .btnGhost.active{border-color:rgba(200,169,81,.3);color:var(--gold);background:rgba(200,169,81,.06);}

    /* ---- Indicator cards ---- */
    .indCard{
      background:var(--card);border:1px solid var(--line);border-radius:3px;
      padding:.55rem .65rem;
    }
    .indCard .code{font-family:var(--mono);font-size:.6rem;font-weight:700;letter-spacing:.1em;color:var(--muted);}
    .indCard .val{font-weight:800;font-size:.9rem;margin-top:.15rem;color:rgba(255,255,255,.92);}
    .indCard .chg{font-family:var(--mono);font-size:.68rem;font-weight:700;margin-top:.1rem;}
    .indCard .up{color:var(--green);}
    .indCard .dn{color:var(--red);}

    /* ---- Wire cards ---- */
    .wireCard{
      background:var(--card);border:1px solid var(--line);border-radius:3px;
      overflow:hidden;transition:all .12s;cursor:pointer;
    }
    .wireCard:hover{border-color:rgba(200,169,81,.2);background:var(--card2);}
    .wireCard .wireImg{width:100%;height:110px;object-fit:cover;display:block;background:var(--bg2);}
    .wireCard .wireBody{padding:.75rem .85rem;}
    .wireTitle{font-weight:700;font-size:.85rem;line-height:1.25;margin-top:.35rem;color:rgba(255,255,255,.9);}
    .wireMeta{display:flex;justify-content:space-between;align-items:center;margin-top:.35rem;font-size:.6rem;color:var(--muted);font-family:var(--mono);letter-spacing:.06em;}
    .wireKp{color:var(--sub);font-size:.78rem;line-height:1.4;margin-top:.1rem;}

    /* ---- Impact tags ---- */
    .impactTag{
      font-family:var(--mono);font-size:.52rem;letter-spacing:.14em;
      font-weight:700;padding:.12rem .3rem;border-radius:2px;
      border:1px solid rgba(255,255,255,.08);display:inline-flex;align-items:center;
    }
    .impactHigh{color:var(--red);border-color:rgba(239,68,68,.2);background:rgba(239,68,68,.06);}
    .impactMed{color:var(--gold);border-color:rgba(200,169,81,.2);background:rgba(200,169,81,.06);}
    .impactLow{color:var(--green);border-color:rgba(34,197,94,.18);background:rgba(34,197,94,.04);}

    /* ---- Section label ---- */
    .secLabel{
      font-family:var(--mono);font-size:.58rem;letter-spacing:.16em;
      font-weight:700;color:var(--gold);
    }

    /* ---- Modal ---- */
    .modalBackdrop{
      position:fixed;inset:0;background:rgba(0,0,0,.82);
      backdrop-filter:blur(6px);display:none;align-items:center;justify-content:center;
      z-index:50;padding:16px;
    }
    .modalBackdrop.show{display:flex;}
    .modalPanel{
      width:min(860px,calc(100vw - 32px));max-height:min(94vh,960px);
      overflow:auto;border-radius:3px;border:1px solid var(--line);
      background:var(--bg);box-shadow:0 24px 80px rgba(0,0,0,.7);
    }
    .modalHeader{
      position:sticky;top:0;z-index:2;background:rgba(9,9,11,.97);
      border-bottom:1px solid var(--line);padding:.5rem 1rem;
      display:flex;align-items:center;justify-content:space-between;
    }
    .modalHeaderLeft{font-family:var(--mono);font-size:.58rem;letter-spacing:.2em;font-weight:700;color:var(--muted);}
    .modalHeaderLeft b{color:var(--gold);}
    .closeBtn{
      font-family:var(--mono);border:1px solid rgba(255,255,255,.08);
      padding:.25rem .5rem;border-radius:2px;font-weight:700;
      font-size:.6rem;letter-spacing:.1em;color:var(--sub);background:transparent;
    }
    .closeBtn:hover{border-color:rgba(200,169,81,.25);color:var(--gold);}
    .modalBody{padding:0;}

    /* ---- Brief section numbering ---- */
    .briefNum{font-family:var(--mono);font-weight:700;color:var(--gold);font-size:.68rem;}
    .briefSep{font-family:var(--mono);font-weight:700;color:var(--muted2);font-size:.55rem;letter-spacing:.12em;}
    .briefSecLabel{font-family:var(--mono);font-weight:700;color:var(--sub);font-size:.58rem;letter-spacing:.12em;}

    /* ---- Status bar ---- */
    .statusBar{
      position:fixed;bottom:0;left:0;right:0;
      background:rgba(9,9,11,.96);border-top:1px solid var(--line);
      padding:.3rem 1.5rem;display:flex;align-items:center;justify-content:space-between;
      font-family:var(--mono);font-size:.55rem;letter-spacing:.1em;color:var(--muted);z-index:40;
    }
    .statusBar .live{color:var(--green);}

    /* ---- Headline ticker items ---- */
    .hlItem{
      display:flex;align-items:center;gap:.6rem;
      padding:.45rem .7rem;
      border-bottom:1px solid rgba(255,255,255,.03);
      transition:background .1s;
    }
    .hlItem:last-child{border-bottom:none;}
    .hlItem:hover{background:rgba(255,255,255,.015);}
    .hlItem .hlTime{
      font-family:var(--mono);font-size:.55rem;font-weight:600;
      color:var(--gold);letter-spacing:.06em;
      flex:0 0 42px;text-align:right;
    }
    .hlItem .hlText{
      flex:1;min-width:0;
      font-size:.78rem;font-weight:600;color:rgba(255,255,255,.7);
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }
    .hlItem .hlSrc{
      font-family:var(--mono);font-size:.5rem;font-weight:600;
      color:var(--muted);letter-spacing:.06em;
      flex:0 0 auto;
    }

    /* ---- TOP NEWS ---- */
    .topNewsWrap{margin-bottom:1.2rem;}
    .tnLayout{
      display:grid;grid-template-columns:1.15fr .85fr;gap:12px;margin-top:.6rem;
    }
    .tnFeatured{
      background:var(--card);border:1px solid var(--line);border-radius:3px;
      overflow:hidden;cursor:pointer;transition:border-color .12s;
      display:flex;flex-direction:column;
    }
    .tnFeatured:hover{border-color:rgba(200,169,81,.2);}
    .tnFeaturedImg{
      width:100%;height:170px;object-fit:cover;display:block;
      background:linear-gradient(135deg,#0c0c10,#10101a);
    }
    .tnFeaturedBody{padding:1rem 1.1rem;flex:1;display:flex;flex-direction:column;}
    .tnRegion{
      font-family:var(--mono);font-size:.48rem;letter-spacing:.16em;
      font-weight:800;padding:.15rem .4rem;border-radius:2px;
      display:inline-flex;align-items:center;flex:0 0 auto;
    }
    .tnRegion.INDONESIA{color:#c8a951;background:rgba(200,169,81,.08);border:1px solid rgba(200,169,81,.18);}
    .tnRegion.USA{color:#60a5fa;background:rgba(96,165,250,.08);border:1px solid rgba(96,165,250,.18);}
    .tnRegion.ASIA{color:#f472b6;background:rgba(244,114,182,.08);border:1px solid rgba(244,114,182,.18);}
    .tnRegion.EUROPE{color:#34d399;background:rgba(52,211,153,.08);border:1px solid rgba(52,211,153,.18);}
    .tnHeadlineLg{
      font-family:Fraunces,Georgia,serif;font-style:italic;
      font-weight:700;font-size:1.4rem;line-height:1.18;
      color:rgba(255,255,255,.92);margin-top:.55rem;letter-spacing:-.015em;
    }
    .tnLede{
      color:rgba(255,255,255,.5);font-size:.82rem;line-height:1.5;
      margin-top:.45rem;font-family:Georgia,serif;
      display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden;
    }
    .tnMeta{
      margin-top:auto;padding-top:.55rem;display:flex;align-items:center;gap:.6rem;
      font-family:var(--mono);font-size:.52rem;letter-spacing:.08em;color:var(--muted);font-weight:600;
    }
    .tnSideList{display:flex;flex-direction:column;gap:8px;}
    .tnCard{
      background:var(--card);border:1px solid var(--line);border-radius:3px;
      padding:.7rem .8rem;cursor:pointer;transition:all .12s;flex:1;
      display:flex;flex-direction:column;
    }
    .tnCard:hover{border-color:rgba(200,169,81,.18);background:var(--card2);}
    .tnHeadlineSm{
      font-weight:700;font-size:.82rem;line-height:1.22;
      color:rgba(255,255,255,.85);margin-top:.35rem;
      display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;
    }
    .tnCardMeta{
      margin-top:auto;padding-top:.35rem;display:flex;align-items:center;gap:.5rem;
      font-family:var(--mono);font-size:.48rem;letter-spacing:.08em;color:var(--muted2);font-weight:600;
    }

    /* ---- Inline filter bar ---- */
    .filterBar{
      display:flex;align-items:center;gap:.6rem;padding:.55rem 0;
      border-bottom:1px solid var(--line);margin-bottom:1rem;
    }
    .filterLabel{
      font-family:var(--mono);font-size:.52rem;letter-spacing:.14em;
      font-weight:700;color:var(--muted);flex:0 0 auto;
    }
    .filterPills{display:flex;gap:4px;flex-wrap:wrap;}
    .filterPill{
      font-family:var(--mono);font-size:.58rem;letter-spacing:.06em;
      font-weight:700;padding:.22rem .55rem;border-radius:2px;
      border:1px solid rgba(255,255,255,.06);background:transparent;
      color:var(--muted);transition:all .1s;cursor:pointer;
    }
    .filterPill:hover{border-color:rgba(200,169,81,.2);color:var(--sub);}
    .filterPill.active{border-color:rgba(200,169,81,.3);color:var(--gold);background:rgba(200,169,81,.06);}
    .filterDivider{
      width:1px;height:16px;background:var(--line);margin:0 .3rem;
    }

    /* ---- Scrollbar ---- */
    ::-webkit-scrollbar{width:5px;}
    ::-webkit-scrollbar-track{background:transparent;}
    ::-webkit-scrollbar-thumb{background:rgba(255,255,255,.08);border-radius:3px;}
    ::-webkit-scrollbar-thumb:hover{background:rgba(255,255,255,.15);}
  </style>
</head>

<body class="pb-7">
  <div class="w-full min-h-screen">

    <!-- TOP BAR -->
    <div class="topBar">
      <div class="flex items-center gap-5">
        <div class="brand">VELRA <span>TERMINAL</span></div>
        <div class="mono text-[.52rem] tracking-[.16em] text-white/20 font-medium hidden sm:block">MARKET INTELLIGENCE</div>
      </div>
      <div class="flex items-center gap-4">
        <div class="flex items-center gap-1.5 mono text-[.55rem] tracking-[.12em] font-semibold text-white/40">
          <span class="statusDot"></span> LIVE
        </div>
        <button id="btnReconnect" class="btnGhost">RECONNECT</button>
        <div class="mono text-[.52rem] tracking-[.12em] text-white/25 font-medium">
          <span id="lastUpdated">&mdash;</span>
        </div>
      </div>
    </div>

    <!-- REGION PATH -->
    <div class="regionBar">
      <div class="regionPath">
        <span class="active" id="regionPathRegion">INDONESIA</span>
        <span class="mx-1 text-white/15">/</span>
        <span id="regionPathSector">General Market</span>
      </div>
      <div class="flex items-center gap-2">
        <button class="btnGhost" id="wireSortLatest">LATEST</button>
        <button class="btnGhost" id="wireSortImpact">IMPACT</button>
      </div>
    </div>

    <!-- TICKER -->
    <div class="breakingWrap">
      <div class="flex items-center gap-2">
        <div class="breakingBadge">WIRE</div>
        <div class="w-full overflow-hidden">
          <div class="breakingInner" id="tickerTrack"></div>
        </div>
      </div>
    </div>

    <!-- MAIN GRID: sidebar + center + macro -->
    <div class="grid grid-cols-[200px_1fr_260px] gap-0" style="min-height:calc(100vh - 130px)">

      <!-- LEFT NAV -->
      <aside class="border-r border-white/[.04] p-2.5 space-y-2.5 overflow-y-auto" style="max-height:calc(100vh - 160px)">
        <div class="navBox">
          <div class="navTitle"><span class="dot"></span> REGION</div>
          <div id="regionNav"></div>
        </div>
        <div class="navBox">
          <div class="navTitle"><span class="dot" style="background:rgba(255,255,255,.18)"></span> SECTOR</div>
          <div id="sectorNav"></div>
        </div>
      </aside>

      <!-- CENTER -->
      <section class="p-4 space-y-4 overflow-y-auto" style="max-height:calc(100vh - 160px)">

        <!-- TOP NEWS (aggregated across all regions) -->
        <div class="topNewsWrap" id="topNewsSection">
          <div class="flex items-center justify-between">
            <div class="secLabel">TOP NEWS</div>
            <div class="mono text-[.48rem] tracking-[.1em] font-medium text-white/20" id="topNewsCount"></div>
          </div>
          <div class="tnLayout">
            <div class="tnFeatured" id="tnFeatured"></div>
            <div class="tnSideList" id="tnSideList"></div>
          </div>
        </div>

        <!-- INLINE FILTER BAR -->
        <div class="filterBar" id="filterBar">
          <div class="filterLabel">REGION</div>
          <div class="filterPills" id="regionPills"></div>
          <div class="filterDivider"></div>
          <div class="filterLabel">SECTOR</div>
          <div class="filterPills" id="sectorPills"></div>
        </div>

        <!-- MORNING BRIEF / SECTOR SUMMARY (at top) -->
        <div class="card" id="briefCard">
          <div class="flex items-center justify-between px-4 py-2.5 border-b border-white/[.04]">
            <div class="flex items-center gap-3">
              <span class="secLabel" id="briefLabel">MORNING BRIEF</span>
              <span class="mono text-[.5rem] tracking-[.1em] text-white/20 font-medium" id="briefPath">&mdash;</span>
            </div>
            <button id="btnOpenBrief" class="hidden btnGhost">BACA SELENGKAPNYA &rarr;</button>
          </div>
          <div class="px-4 py-3">
            <div class="serifTitle text-[1.3rem] font-bold leading-tight text-white/90" id="briefTitle" style="font-style:italic">Market Update</div>
            <div class="mt-2.5 space-y-1" id="briefBullets"></div>
            <div class="mt-2" id="briefWatchlist"></div>
          </div>
        </div>

        <!-- KEY INDICES -->
        <div>
          <div class="flex items-center justify-between mb-2.5">
            <div class="secLabel">KEY INDICES & MOVERS</div>
            <div class="mono text-[.5rem] tracking-[.1em] font-medium text-white/20" id="indAsOf">&mdash;</div>
          </div>
          <div class="grid grid-cols-5 gap-2" id="indicatorsGrid"></div>
        </div>

        <!-- NEWEST HEADLINE (no-story items) -->
        <div id="headlineSection" class="hidden">
          <div class="flex items-center justify-between mb-2">
            <div class="secLabel">NEWEST HEADLINES</div>
            <div class="mono text-[.48rem] tracking-[.1em] font-medium text-white/20" id="headlineCount"></div>
          </div>
          <div class="card" id="headlineList"></div>
        </div>

        <!-- THE WIRE -->
        <div>
          <div class="flex items-center justify-between mb-2.5">
            <div class="flex items-center gap-3">
              <div class="secLabel">THE WIRE</div>
              <div class="mono text-[.5rem] tracking-[.1em] font-medium text-white/25" id="wireTitle">Live Feed</div>
            </div>
            <div class="mono text-[.5rem] tracking-[.1em] font-medium text-white/20" id="wireMeta"></div>
          </div>
          <div class="grid grid-cols-3 gap-2.5" id="wireGrid"></div>
          <div class="mt-4 text-white/30 text-xs hidden mono tracking-wide" id="wireEmpty">Tidak ada update signifikan &le;24 jam.</div>
        </div>
      </section>

      <!-- RIGHT: MACRO DATA -->
      <aside class="border-l border-white/[.04] p-2.5 overflow-y-auto" style="max-height:calc(100vh - 160px)">
        <div class="card" id="macroCard">
          <div class="flex items-center justify-between px-3 py-2 border-b border-white/[.04]">
            <div class="secLabel text-[.55rem]">DATA MAKRO</div>
            <div class="flex gap-1">
              <button class="btnGhost text-[.5rem] px-1.5 py-0.5" id="macroTabMetric">METRIK</button>
              <button class="btnGhost text-[.5rem] px-1.5 py-0.5" id="macroTabTrend">TREN</button>
              <button class="btnGhost text-[.5rem] px-1.5 py-0.5" id="macroTabNext">NEXT</button>
            </div>
          </div>
          <div class="p-3">
            <div class="mono text-[.5rem] tracking-[.1em] font-medium text-white/25 mb-2" id="macroPath">&mdash;</div>
            <div class="grid grid-cols-4 gap-1 text-[.5rem] mono tracking-[.1em] font-bold text-white/25 mb-2">
              <div>METRIC</div><div class="text-right">PREV</div><div class="text-right">FCAST</div><div class="text-right">ACT</div>
            </div>
            <div class="text-white/35 text-xs" id="macroBody">Menunggu data makro...</div>
          </div>
        </div>
      </aside>
    </div>

    <!-- STATUS BAR -->
    <div class="statusBar">
      <div><span class="live">&#9679;</span> VELRA TERMINAL v4.5 &mdash; CONNECTED</div>
      <div>REFRESH: AUTO &mdash; <span id="statusTime">&mdash;</span></div>
    </div>
  </div>

  <!-- MODAL -->
  <div class="modalBackdrop" id="modalBackdrop">
    <div class="modalPanel">
      <div class="modalHeader">
        <div class="modalHeaderLeft" id="modalKicker"><b>VELRA</b> TERMINAL // INTELLIGENCE</div>
        <div class="flex items-center gap-2" id="modalHeaderRight">
          <button class="closeBtn" id="modalCloseBtn">[ESC] CLOSE</button>
        </div>
      </div>
      <div class="modalBody" id="modalBody"></div>
    </div>
  </div>

  
<script>
const REGION_META = {
  INDONESIA: { label: "Indonesia" },
  USA: { label: "Amerika Serikat" },
  ASIA: { label: "Asia" },
  EUROPE: { label: "Eropa" },
};

const SECTOR_META = {
  GENERAL: "Umum",
  TECHNOLOGY: "Teknologi",
  FINANCE: "Keuangan",
  MINING_ENERGY: "Tambang & Energi",
  HEALTHCARE: "Kesehatan",
  REGULATION: "Regulasi",
  CONSUMER: "Konsumen",
};

const REGIONS = Object.keys(REGION_META);
const SECTORS = Object.keys(SECTOR_META);

const state = {
  region: "INDONESIA",
  sector: "GENERAL",
  sort: "latest",   // latest | impact
  macroTab: "metric", // metric | trend | next
  data: null,
  open: null,       // {type:"brief", region} | {type:"news", item}
};

const STORY_MIN_LEN = 80; // items with story shorter than this go to NEWEST HEADLINES

const el = (id) => document.getElementById(id);

function safeDate(x){
  try { const d = new Date(x); return isNaN(d) ? null : d; } catch { return null; }
}
function esc(s){ return String(s ?? "").replace(/\u00A0/g, " ").replace(/&nbsp;/g, " ").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
function relativeTime(d){
  const now = new Date();
  const diffMs = now.getTime() - d.getTime();
  const mins = Math.floor(diffMs / 60000);
  if (mins < 1) return "baru saja";
  if (mins < 60) return `${mins}m lalu`;
  const hrs = Math.floor(mins / 60);
  if (hrs < 24) return `${hrs}j lalu`;
  const days = Math.floor(hrs / 24);
  return `${days}h lalu`;
}
function stripHtml(s){ return String(s ?? "").replace(/<[^>]*>/g, " ").replace(/&nbsp;/g," ").replace(/\u00A0/g," ").replace(/&#160;/g," ").replace(/\s+/g," ").trim(); }

function wireImageUrl(headline, sector){
  // Deterministic abstract gradient per wire card
  const palettes = {
    TECHNOLOGY: ["0d0d12","111118","0a0f1a"],
    FINANCE: ["0d0d10","0f1118","0c1015"],
    MINING_ENERGY: ["0d0d0d","111311","0c100d"],
    HEALTHCARE: ["0d0d11","0c1015","0f1118"],
    REGULATION: ["0f0d0d","120f0f","150d0d"],
    CONSUMER: ["0d0d11","0d100d","11110d"],
    GENERAL: ["0c0c0f","0f0f12","0b0b0e"],
  };
  const colors = palettes[sector] || palettes.GENERAL;
  let h = 0;
  for (let i = 0; i < (headline||"").length; i++) h = ((h << 5) - h + headline.charCodeAt(i)) | 0;
  const idx = Math.abs(h) % 6;
  const c1 = colors[idx % colors.length];
  const c2 = colors[(idx + 1) % colors.length];
  return `data:image/svg+xml,${encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="400" height="200"><defs><linearGradient id="g" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#${c1}"/><stop offset="100%" style="stop-color:#${c2}"/></linearGradient></defs><rect width="400" height="200" fill="url(#g)"/><text x="200" y="106" text-anchor="middle" font-family="monospace" font-size="9" fill="rgba(255,255,255,0.06)" letter-spacing="5">${(sector||"WIRE").slice(0,12)}</text></svg>`)}`;
}

function impactRank(v){
  const x = String(v||"").toUpperCase();
  if (x === "HIGH") return 3;
  if (x === "MEDIUM") return 2;
  if (x === "LOW") return 1;
  return 0;
}

// ===== Client-side sector inference (fallback when worker data lacks sector info) =====
const SECTOR_KW = {
  TECHNOLOGY: [
    "tech","technology","teknologi","digital","digitalisasi","digitalization",
    "ai","artificial intelligence","kecerdasan buatan","machine learning","deep learning",
    "semiconductor","semikonduktor","chip","chipset","gpu","cpu","prosesor","processor",
    "nvidia","amd","tsmc","intel","qualcomm","broadcom","asml",
    "software","saas","cloud","aws","azure","gcp","cybersecurity","ransomware","data breach","siber",
    "smartphone","iphone","android","handphone","gadget","perangkat","device",
    "telecom","telekomunikasi","telkom","indosat","xl","5g","4g","internet","wifi","fiber","optik",
    "startup","venture","unicorn","fintech","edtech","healthtech",
    "robot","robotik","automation","otomasi","quantum","computing","komputasi",
    "openai","chatgpt","gemini","anthropic","meta","google","apple","microsoft","amazon","samsung","sony",
    "aplikasi","app","platform","website","e-mail","data center","pusat data",
    "streaming","netflix","spotify","tiktok","youtube","instagram","whatsapp",
    "blockchain","crypto","bitcoin","ethereum","kripto","nft","web3",
    "gopay","dana","ovo","shopeepay","tokopedia","bukalapak","blibli"
  ],
  FINANCE: [
    "bank","banking","perbankan","keuangan","finansial","financial",
    "bca","bri","bni","mandiri","bsi","cimb","danamon","permata","mega","btn","bbca","bbri","bbni","bmri",
    "central bank","bank sentral","fed","fomc","ecb","boj","boe","rba","pboc","bi rate",
    "bank indonesia","ojk","idx","bei","bursa efek",
    "interest rate","suku bunga","rate cut","rate hike","dovish","hawkish",
    "yield","bond","obligasi","treasury","sbn","sukuk",
    "inflation","inflasi","deflasi","deflation","cpi","ppi","unemployment","nfp","gdp","pdb",
    "resesi","recession","recovery","pemulihan",
    "forex","currency","mata uang","dollar","dolar","usd","eur","jpy","rupiah","idr","dxy","valas",
    "saham","stocks","stock","shares","equity","ekuitas","investasi","investment","investor","reksadana","mutual fund",
    "index","indices","indeks","bursa","ihsg","idx","lq45","nasdaq","s&p","dow","wall street","nikkei","hang seng","kospi",
    "trading","perdagangan","transaksi","sell-off","rally","bullish","bearish","koreksi","correction",
    "market","pasar","pasar modal","capital market","risk-on","risk-off",
    "capital flow","outflow","inflow","asing","foreign","asing jual","asing beli","net buy","net sell",
    "earnings","profit","laba","rugi","loss","pendapatan","revenue","guidance","dividend","dividen","buyback","ipo","rights issue",
    "asuransi","insurance","leasing","multifinance","pinjaman","kredit","loan","mortgage",
    "fintech","p2p","paylater","payment","pembayaran"
  ],
  MINING_ENERGY: [
    "oil","crude","brent","wti","opec","opec+","minyak","minyak mentah","minyak dunia",
    "gas","lng","natural gas","gas alam","gas bumi","diesel","fuel","bbm","pertamina","bensin","solar",
    "energy","energi","power","electricity","listrik","pln","utility","pembangkit","pltu","plta","plts",
    "ebt","renewable","terbarukan","solar panel","wind","angin","geothermal","panas bumi",
    "coal","batubara","batu bara","adaro","bumi resources","itmg","ptba",
    "mining","tambang","pertambangan","minerals","mineral","smelter","hilirisasi","refinery",
    "nickel","nikel","copper","tembaga","tin","timah","bauxite","bauksit","alumina","aluminium",
    "gold","emas","silver","perak","platinum","palladium","logam mulia","antam",
    "ev","electric vehicle","kendaraan listrik","baterai","battery","lithium","rare earth","kobalt","cobalt",
    "freeport","vale","aneka tambang","bukit asam","medco","elnusa"
  ],
  HEALTHCARE: [
    "health","healthcare","kesehatan","sehat","hospital","rumah sakit","rs","rsud",
    "clinic","klinik","pharmacy","farmasi","apotek",
    "pharma","pharmaceutical","drug","obat","vaccine","vaksin","booster","imunisasi",
    "biotech","bioteknologi","biofarmasi","genomic",
    "medical","medis","kedokteran","doctor","dokter","perawat","nurse","nakes","tenaga kesehatan",
    "bpjs","jkn","kalbe","sido muncul","kimia farma","bio farma","indofarma","phapros",
    "who","pandemic","pandemi","endemic","endemi","outbreak","wabah",
    "covid","virus","flu","demam","penyakit","disease","cancer","kanker",
    "fda","bpom","clinical trial","uji klinis","riset kesehatan",
    "alat kesehatan","alkes","diagnostik","diagnostic","lab","laboratorium"
  ],
  REGULATION: [
    "regulation","regulasi","regulator","regulated","policy","kebijakan","aturan","peraturan",
    "law","hukum","undang-undang","uu","perppu","pp","permen",
    "government","pemerintah","pemerintahan","kementerian","ministry",
    "sanction","sanksi","embargo","ban","larangan","restriction","pembatasan",
    "tariff","tarif","bea masuk","bea cukai","customs","trade war","perang dagang",
    "tax","pajak","ppn","pph","cukai","fiskal","fiscal","apbn","apbd","anggaran","budget",
    "subsidy","subsidi","insentif","incentive","stimulus",
    "antitrust","competition","monopoly","persaingan","merger","akuisisi","acquisition",
    "probe","investigation","penyelidikan","korupsi","corruption","kpk","kejaksaan",
    "sec","doj","ftc","ojk","bi","kppu","kemenkeu","bappebti","lps","kominfo",
    "dpr","dprd","presiden","president","menteri","minister","gubernur","governor",
    "election","pemilu","pilkada","politik","political","geopolitik","geopolitical",
    "omnibus","cipta kerja","perizinan","licensing","compliance","kepatuhan",
    "sidang","tribunal","court","pengadilan","putusan","verdict","ruling"
  ],
  CONSUMER: [
    "consumer","konsumen","retail","ritel","eceran","fmcg","consumer goods","barang konsumsi",
    "e-commerce","ecommerce","marketplace","toko online","online shop",
    "shopping","belanja","mall","pusat perbelanjaan",
    "sales","penjualan","spending","konsumsi","consumption","daya beli","purchasing power",
    "travel","tourism","pariwisata","wisata","wisatawan","tourist",
    "airline","maskapai","garuda","lion air","airasia","citilink","penerbangan","flight",
    "hotel","resort","restoran","restaurant","cafe","kafe",
    "food","makanan","beverage","minuman","grocery","supermarket","minimarket","indomaret","alfamart",
    "unilever","indofood","mayora","wings","kapal api","abc","sosro",
    "automotive","otomotif","car","mobil","motorcycle","motor","sepeda motor",
    "toyota","honda","suzuki","daihatsu","mitsubishi","hyundai","astra","adira",
    "gojek","grab","shopee","tokopedia","lazada","bukalapak","blibli","traveloka",
    "properti","property","real estate","rumah","house","apartemen","apartment",
    "fashion","pakaian","clothing","sepatu","shoes","brand","merek"
  ],
};

function clientInferSectors(text){
  const t = String(text||"").toLowerCase();
  if (!t || t.length < 3) return [];
  const matched = [];
  for (const [sector, kws] of Object.entries(SECTOR_KW)) {
    let score = 0;
    for (const kw of kws) {
      if (kw.includes(" ") || kw.includes("/") || kw.includes("-") || kw.includes("&")) {
        // multi-word / compound: substring match
        if (t.includes(kw)) score += 2;
      } else if (kw.length <= 3) {
        // very short keywords (ai, ev, bi, rs, uu, pp etc.): use word boundary
        const re = new RegExp("\\b" + kw.replace(/[.*+?^${}()|[\]\\]/g,"\\$&") + "\\b", "i");
        if (re.test(t)) score += 1;
      } else {
        // Longer single words: try word boundary first, then substring fallback
        const escaped = kw.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");
        const re = new RegExp("\\b" + escaped + "\\b", "i");
        if (re.test(t)) {
          score += 1;
        } else if (kw.length >= 5 && t.includes(kw)) {
          // substring fallback for longer keywords (avoids false positives on short ones)
          score += 1;
        }
      }
    }
    if (score > 0) matched.push({ sector, score });
  }
  matched.sort((a,b) => b.score - a.score);
  return matched.slice(0,3).map(x => x.sector);
}

function itemMatchesSector(item, sector){
  // 1. Direct match on item.sector
  if (item.sector === sector) return true;
  // 2. Match on item.sectors array (from worker or enriched)
  if (Array.isArray(item.sectors) && item.sectors.includes(sector)) return true;
  // 3. Client-side keyword inference from ALL available text
  const parts = [item.headline];
  if (Array.isArray(item.keypoints)) parts.push(...item.keypoints);
  if (item.story) parts.push(item.story);
  if (item.category) parts.push(item.category);
  const text = parts.join(" ");
  const inferred = clientInferSectors(text);
  return inferred.includes(sector);
}

function normalizeData(raw){
  const d = raw || {};
  d.generatedAt = d.generatedAt || d.generated_at_wib || d.generated_at || null;

  d.indices = d.indices || {};
  d.indicators = d.indicators || d.indices || {};
  delete d.indices?.AMERICAS;
  delete d.indicators?.AMERICAS;

  d.livewire = Array.isArray(d.livewire) ? d.livewire : [];
  d.livewire = d.livewire
    .filter(x => x && REGIONS.includes(x.region) && SECTORS.includes(x.sector))
    .map(x => {
      const item = {
        id: String(x.id || ""),
        storyKey: x.storyKey || x.id || "",
        region: x.region,
        sector: x.sector,
        sectors: Array.isArray(x.sectors) ? x.sectors : [],
        impact: String(x.impact || "MEDIUM").toUpperCase(),
        headline: String(x.headline || x.title || "").trim(),
        keypoints: Array.isArray(x.keypoints) ? x.keypoints.map(String).filter(Boolean).slice(0,3) : [],
        publishedAt: x.publishedAt || x.published_at || null,
        sources: Array.isArray(x.sources) ? x.sources : [],
        story: x.story || x.body || "",
        category: x.category || null,
      };
      // Enrich item.sectors with client-side inference (for sector filter matching).
      // IMPORTANT: do NOT change item.sector — it must stay as-is so the GENERAL
      // view keeps showing all items that were originally tagged GENERAL.
      const inferText = [item.headline, ...item.keypoints, item.story, item.category].filter(Boolean).join(" ");
      const inferred = clientInferSectors(inferText);
      if (inferred.length) {
        // Merge worker sectors + inferred sectors (deduplicated)
        const merged = new Set([...item.sectors, ...inferred]);
        merged.delete("GENERAL"); // remove GENERAL from inferred to keep it meaningful
        item.sectors = Array.from(merged);
      }
      return item;
    })
    .filter(x => x.headline);

  // briefings: region + sector digests
  d.briefings = d.briefings || {};
  if (!d.briefings.regions) {
    // Migrate old shapes best-effort
    const reg = {};
    const legacyMap = { indonesia:"INDONESIA", usa:"USA", asia:"ASIA", europe:"EUROPE" };
    for (const [k,v] of Object.entries(d.briefings)) {
      if (!legacyMap[k]) continue;
      const r = legacyMap[k];
      reg[r] = reg[r] || {};
      reg[r].GENERAL = {
        title: v?.title || "Market Update",
        bullets: Array.isArray(v?.bullets) ? v.bullets : [],
        watchlist: Array.isArray(v?.what_to_watch) ? v.what_to_watch : [],
        updatedAt: d.generatedAt,
      };
    }
    d.briefings = { regions: reg };
  }

  d.morningBriefs = d.morningBriefs || d.morning_briefs || {};

  d.macro = d.macro || { updatedAt: null, source: null, regions: {} };
  return d;
}

async function fetchData(){
  const url = "/data.json?t=" + Date.now();
  const r = await fetch(url, { cache:"no-store" });
  const raw = await r.json();
  state.data = normalizeData(raw);

  // Debug: log sector distribution after normalization
  const sectorDist = {};
  for (const it of state.data.livewire) {
    sectorDist[it.sector] = (sectorDist[it.sector] || 0) + 1;
  }
  console.log("[VELRA DEBUG] Total livewire items:", state.data.livewire.length);
  console.log("[VELRA DEBUG] By primary sector:", JSON.stringify(sectorDist));

  // Debug: sample items for each region
  for (const region of REGIONS) {
    const regionItems = state.data.livewire.filter(x => x.region === region);
    console.log(`[VELRA DEBUG] ${region}: ${regionItems.length} items`);
    if (regionItems.length > 0) {
      console.log(`[VELRA DEBUG] ${region} sample headlines:`, regionItems.slice(0,3).map(x => `[${x.sector}] ${x.headline}`));
    }
    for (const sector of SECTORS) {
      if (sector === "GENERAL") continue;
      const count = filteredWire(region, sector).length;
      if (count > 0) console.log(`[VELRA DEBUG] ${region}/${sector}: ${count} items`);
    }
  }
}

function renderNav(){
  const rn = el("regionNav");
  const sn = el("sectorNav");
  rn.innerHTML = "";
  sn.innerHTML = "";

  REGIONS.forEach(r => {
    const b = document.createElement("button");
    b.className = "navItem" + (state.region===r ? " active" : "");
    b.innerHTML = `<span>${esc(REGION_META[r].label)}</span>`;
    b.onclick = () => { state.region = r; renderAll(); };
    rn.appendChild(b);
  });

  SECTORS.forEach(s => {
    const b = document.createElement("button");
    b.className = "navItem" + (state.sector===s ? " active" : "");
    b.textContent = SECTOR_META[s];
    b.onclick = () => { state.sector = s; renderAll(); };
    sn.appendChild(b);
  });

  el("wireSortLatest").onclick = () => { state.sort="latest"; renderWire(); };
  el("wireSortImpact").onclick = () => { state.sort="impact"; renderWire(); };

  const setMacroTab = (t) => { state.macroTab = t; renderMacro(); };
  el("macroTabMetric").onclick = () => setMacroTab("metric");
  el("macroTabTrend").onclick = () => setMacroTab("trend");
  el("macroTabNext").onclick = () => setMacroTab("next");
}

function filteredWire(region, sector){
  const now = new Date();
  const maxAgeMs = 24 * 60 * 60 * 1000; // 24 hours strict
  const arr = (state.data?.livewire || []).filter(x => {
    if (x.region !== region) return false;
    // Client-side TTL: reject items older than 24h
    const t = safeDate(x.publishedAt);
    if (t && (now.getTime() - t.getTime()) > maxAgeMs) return false;
    return true;
  });

  // Helper: deduplicate by storyKey, keeping the richest version
  function dedup(items) {
    const seen = new Map();
    for (const x of items) {
      const key = x.storyKey || x.id;
      const prev = seen.get(key);
      if (!prev || (x.story && x.story.length > (prev.story||"").length)) seen.set(key, x);
    }
    return Array.from(seen.values());
  }

  if (sector === "GENERAL") {
    // GENERAL = aggregated view of ALL items for the region, deduplicated
    const all = dedup(arr);
    return all.sort((a,b) => {
      const ia=impactRank(a.impact), ib=impactRank(b.impact);
      if (ia!==ib) return ib-ia;
      return (safeDate(b.publishedAt)?.getTime()||0)-(safeDate(a.publishedAt)?.getTime()||0);
    }).slice(0,18);
  }

  // For specific sectors: use itemMatchesSector which checks
  // item.sector, item.sectors[], AND client-side keyword inference
  const matched = arr.filter(x => itemMatchesSector(x, sector));
  const unique = dedup(matched);
  // Cap at 10 for sector views, sorted by impact then recency
  return unique.sort((a,b) => {
    const ia=impactRank(a.impact), ib=impactRank(b.impact);
    if (ia!==ib) return ib-ia;
    return (safeDate(b.publishedAt)?.getTime()||0)-(safeDate(a.publishedAt)?.getTime()||0);
  }).slice(0, 10);
}

function getDigest(region, sector){
  const d = state.data?.briefings?.regions?.[region]?.[sector];
  if (d) return d;

  const items = filteredWire(region, sector).slice(0,5);
  return {
    title: sector==="GENERAL" ? "Market Update" : `${SECTOR_META[sector]} Update`,
    bullets: items.map(x => x.headline).slice(0,5),
    watchlist: [],
    updatedAt: state.data?.generatedAt || null,
  };
}

function buildMiniChart(region) {
  // Generate a mini SVG sparkline/market pulse from indicator data
  const ind = state.data?.indicators?.[region] || state.data?.indices?.[region] || [];
  const items = ind.slice(0, 6);
  if (!items.length) {
    // Placeholder pulse line
    return `<svg viewBox="0 0 320 60" class="w-full h-14 mt-2 opacity-40"><path d="M0,35 Q40,15 80,30 T160,25 T240,35 T320,20" fill="none" stroke="rgba(200,169,81,.5)" stroke-width="1.5"/><circle cx="320" cy="20" r="2.5" fill="rgba(200,169,81,.6)"/></svg>`;
  }
  // Build mini bar chart from actual indicator changes
  const maxAbs = Math.max(1, ...items.map(x => Math.abs(x.changePct || 0)));
  const barW = Math.floor(280 / items.length);
  const bars = items.map((it, i) => {
    const ch = it.changePct || 0;
    const h = Math.max(3, Math.abs(ch) / maxAbs * 35);
    const y = ch >= 0 ? 40 - h : 40;
    const color = ch >= 0 ? "rgba(34,197,94,.5)" : "rgba(239,68,68,.45)";
    const x = 20 + i * barW;
    const code = (it.code || "").slice(0, 5);
    return `<rect x="${x}" y="${y}" width="${barW - 4}" height="${h}" rx="1.5" fill="${color}"/>
      <text x="${x + (barW - 4) / 2}" y="56" text-anchor="middle" font-family="var(--mono)" font-size="6" fill="rgba(255,255,255,.25)">${code}</text>`;
  }).join("");
  return `<svg viewBox="0 0 320 62" class="w-full h-14 mt-2">${bars}<line x1="20" y1="40" x2="${20 + items.length * barW}" y2="40" stroke="rgba(255,255,255,.06)" stroke-width="0.5"/></svg>`;
}

function renderBrief(){
  const region = state.region;
  const sector = state.sector;

  el("briefLabel").textContent = (sector==="GENERAL") ? "MORNING BRIEF" : "RANGKUMAN SEKTOR";
  el("briefPath").textContent = `${REGION_META[region].label} / ${SECTOR_META[sector]}`;

  const btn = el("btnOpenBrief");
  const hasBrief = !!state.data?.morningBriefs?.[region]?.slides?.length;
  if (sector==="GENERAL" && hasBrief) btn.classList.remove("hidden");
  else btn.classList.add("hidden");
  btn.onclick = () => openBrief(region);

  if (sector==="GENERAL") {
    const mb = state.data?.morningBriefs?.[region];
    const digest = getDigest(region, "GENERAL");
    el("briefTitle").textContent = mb?.title || digest.title || "Market Update";

    // For GENERAL: show a mini chart + lede, no keypoints
    const lede = mb?.lede || (digest?.bullets?.[0]) || "";
    const chart = buildMiniChart(region);
    el("briefBullets").innerHTML = `
      ${chart}
      ${lede ? `<div class="mt-2 text-white/50 text-[.82rem] leading-relaxed" style="font-family:Georgia,serif">${esc(lede)}</div>` : `<div class="text-white/30 text-xs mono tracking-wide mt-2">Menunggu ringkasan terbaru.</div>`}
    `;
    el("briefWatchlist").innerHTML = "";
    return;
  }

  // For SECTOR views: show bold keypoints
  const dig = getDigest(region, sector);
  el("briefTitle").textContent = dig.title || `${SECTOR_META[sector]} Update`;
  const bullets = (dig.bullets || []).slice(0, 5);
  el("briefBullets").innerHTML = bullets.length
    ? bullets.map((t, i) => `
        <div class="flex gap-2.5 items-start py-1.5 ${i > 0 ? 'border-t border-white/[.03]' : ''}">
          <span class="mono text-[.6rem] font-bold text-[var(--gold)] mt-0.5">${String(i+1).padStart(2,"0")}</span>
          <span class="text-white/70 text-[.82rem] leading-snug font-medium">${esc(t)}</span>
        </div>
      `).join("")
    : `<div class="text-white/30 text-xs mono tracking-wide">Belum ada poin penting signifikan ≤24 jam.</div>`;
  el("briefWatchlist").innerHTML = "";
}

function renderMacro(){
  const region = state.region;
  const tab = state.macroTab || "metric";
  const macro = state.data?.macro?.regions?.[region] || {};
  const rows = (macro?.[tab] || []).slice(0, 8);

  const tabLabel = tab==="metric" ? "METRIK" : (tab==="trend" ? "TREN" : "NEXT");
  el("macroPath").textContent = `${REGION_META[region].label} · ${tabLabel}`;

  el("macroBody").innerHTML = rows.length
    ? rows.map(r => `
        <div class="grid grid-cols-4 gap-2 items-start py-2 border-b border-white/10">
          <div>
            <div class="text-white/80 text-sm font-semibold">${esc(r.metric || "")}</div>
            <div class="text-[.70rem] text-white/45 mt-1">${esc(r.currency || "")}${r.when ? ` · ${esc(r.when)}` : ""}${r.impact ? ` · ${esc(String(r.impact).toUpperCase())}` : ""}</div>
          </div>
          <div class="text-right text-white/85 font-extrabold">${esc(r.previous || "—")}</div>
          <div class="text-right text-white/85 font-extrabold">${esc(r.forecast || "—")}</div>
          <div class="text-right text-white/88 font-bold">${esc(r.actual || "—")}</div>
        </div>
      `).join("")
    : `<div class="text-white/45">Tidak ada data macro.</div>`;
}

function renderIndicators(){
  const region = state.region;
  const ind = state.data?.indicators?.[region] || state.data?.indices?.[region] || [];
  const asOf = safeDate(state.data?.generatedAt);
  el("indAsOf").textContent = asOf ? `As of ${asOf.toLocaleString("id-ID",{hour:"2-digit",minute:"2-digit"})}` : "As of —";

  const grid = el("indicatorsGrid");
  grid.innerHTML = "";
  if (!ind.length) {
    grid.innerHTML = `<div class="text-white/45">Indikator belum tersedia.</div>`;
    return;
  }

  ind.slice(0,12).forEach(it => {
    const ch = (typeof it.changePct==="number") ? it.changePct : null;
    const chTxt = ch===null ? "—" : (ch>=0 ? `+${ch.toFixed(2)}%` : `${ch.toFixed(2)}%`);
    const chCls = ch===null ? "" : (ch>=0 ? "up" : "dn");

    const card = document.createElement("div");
    card.className = "indCard";
    card.innerHTML = `
      <div class="code">${esc(it.code || "")}</div>
      <div class="val">${esc(it.valueFmt || it.value || "—")}</div>
      <div class="chg ${chCls}">${esc(chTxt)}</div>
    `;
    grid.appendChild(card);
  });
}

function hasStory(item) {
  const s = stripHtml(item.story || "");
  return s.length >= STORY_MIN_LEN && s.toLowerCase() !== item.headline.toLowerCase().trim();
}

function renderHeadlines(){
  const region = state.region;
  const sector = state.sector;
  const allItems = filteredWire(region, sector);
  // Items WITHOUT a substantive story = headlines only
  const headlines = allItems.filter(x => !hasStory(x))
    .sort((a,b) => (safeDate(b.publishedAt)?.getTime()||0)-(safeDate(a.publishedAt)?.getTime()||0))
    .slice(0, 12);

  const section = el("headlineSection");
  const list = el("headlineList");

  if (!headlines.length) {
    section.classList.add("hidden");
    return;
  }
  section.classList.remove("hidden");
  el("headlineCount").textContent = `${headlines.length} headlines`;

  list.innerHTML = headlines.map(it => {
    const t = safeDate(it.publishedAt);
    const timeTxt = t ? relativeTime(t) : "";
    const src = (it.sources||[]).map(s => s?.name).filter(Boolean).slice(0,1).join("");
    return `<div class="hlItem">
      <span class="hlTime">${esc(timeTxt)}</span>
      <span class="hlText">${esc(it.headline)}</span>
      ${src ? `<span class="hlSrc">${esc(src)}</span>` : ""}
    </div>`;
  }).join("");
}

function renderWire(){
  const region = state.region;
  const sector = state.sector;
  const allItems = filteredWire(region, sector);
  // Only items WITH a substantive story
  let items = allItems.filter(x => hasStory(x));

  if (state.sort==="impact") {
    items.sort((a,b)=>{
      const ia=impactRank(a.impact), ib=impactRank(b.impact);
      if (ia!==ib) return ib-ia;
      return (safeDate(b.publishedAt)?.getTime()||0)-(safeDate(a.publishedAt)?.getTime()||0);
    });
  } else {
    items.sort((a,b)=> (safeDate(b.publishedAt)?.getTime()||0)-(safeDate(a.publishedAt)?.getTime()||0));
  }

  const max = (sector==="GENERAL") ? 15 : 8;
  items = items.slice(0, max);

  el("wireTitle").textContent = `${REGION_META[region].label} / ${SECTOR_META[sector]}`;
  el("wireMeta").textContent = items.length ? `${items.length} stories` : "";

  const grid = el("wireGrid");
  grid.innerHTML = "";

  if (!items.length) {
    const totalRegion = (state.data?.livewire || []).filter(x => x.region===region).length;
    const emptyEl = el("wireEmpty");
    if (totalRegion === 0) {
      emptyEl.textContent = `Belum ada berita untuk ${REGION_META[region].label}. Data akan diperbarui saat worker berikutnya berjalan.`;
    } else if (sector !== "GENERAL") {
      emptyEl.textContent = `Tidak ada berita ${SECTOR_META[sector]} dengan story untuk ${REGION_META[region].label}. (Lihat Headlines di atas)`;
    } else {
      emptyEl.textContent = "Belum ada wire dengan story. Headlines tersedia di atas.";
    }
    emptyEl.classList.remove("hidden");
    return;
  }
  el("wireEmpty").classList.add("hidden");

  items.forEach(it => {
    const t = safeDate(it.publishedAt);
    const timeTxt = t ? relativeTime(t) : "—";
    const imp = String(it.impact||"MEDIUM").toUpperCase();
    const impCls = imp==="HIGH" ? "impactHigh" : imp==="LOW" ? "impactLow" : "impactMed";

    const kp = (it.keypoints || []).slice(0,3);
    const src = (it.sources||[]).map(s => s?.name).filter(Boolean).slice(0,2).join(" • ");

    const card = document.createElement("div");
    card.className = "wireCard";
    const imgUrl = wireImageUrl(it.headline, it.sector);
    card.innerHTML = `
      <img class="wireImg" src="${imgUrl}" alt="" loading="lazy">
      <div class="wireBody">
        <div class="flex items-center justify-between">
          <div class="impactTag ${impCls}">${esc(imp)}</div>
          <div class="mono text-[.58rem] font-bold tracking-[.1em] text-white/40">${esc(timeTxt)}</div>
        </div>
        <div class="wireTitle">${esc(it.headline)}</div>
        ${kp.length ? `<div class="mt-2 space-y-1">${kp.map(x=>`<div class="wireKp">• ${esc(x)}</div>`).join("")}</div>` : ``}
        ${src ? `<div class="wireMeta"><span>${esc(src)}</span></div>` : ``}
      </div>
    `;
    card.onclick = () => openNews(it);
    grid.appendChild(card);
  });
}

function renderTicker(){
  const region = state.region;
  const items = filteredWire(region, "GENERAL").slice(0,12);
  const track = el("tickerTrack");
  const parts = items.map(it => `<span class="mr-4">${esc(it.headline)}</span>`);
  track.innerHTML = parts.join(`<span class="mx-3 opacity-40">•</span>`) || `<span>Menunggu update...</span>`;
}

function getTopNewsItems(){
  // Aggregate top news from ALL regions, sorted by impact then recency
  const now = new Date();
  const maxAgeMs = 24 * 60 * 60 * 1000;
  const all = (state.data?.livewire || []).filter(x => {
    const t = safeDate(x.publishedAt);
    if (t && (now.getTime() - t.getTime()) > maxAgeMs) return false;
    return true;
  });
  // Deduplicate by storyKey
  const seen = new Map();
  for (const x of all) {
    const key = x.storyKey || x.id;
    const prev = seen.get(key);
    if (!prev || (x.story && x.story.length > (prev.story||"").length)) seen.set(key, x);
  }
  const unique = Array.from(seen.values());
  // Sort: HIGH impact first, then by recency
  unique.sort((a,b) => {
    const ia = impactRank(a.impact), ib = impactRank(b.impact);
    if (ia !== ib) return ib - ia;
    return (safeDate(b.publishedAt)?.getTime()||0) - (safeDate(a.publishedAt)?.getTime()||0);
  });
  return unique;
}

function topNewsImage(headline, region){
  // Deterministic gradient per region for top news featured card
  const regionColors = {
    INDONESIA: ["0d0d10","12111a","0a0e18","c8a951"],
    USA:       ["0b0d14","0d1020","0a0f1c","60a5fa"],
    ASIA:      ["100d12","140d14","120a10","f472b6"],
    EUROPE:    ["0b100d","0d140f","0a120c","34d399"],
  };
  const cols = regionColors[region] || regionColors.INDONESIA;
  let h = 0;
  for (let i = 0; i < (headline||"").length; i++) h = ((h << 5) - h + headline.charCodeAt(i)) | 0;
  const idx = Math.abs(h) % 3;
  return `data:image/svg+xml,${encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="600" height="300"><defs><linearGradient id="g" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#${cols[idx]}"/><stop offset="50%" style="stop-color:#${cols[(idx+1)%3]}"/><stop offset="100%" style="stop-color:#${cols[(idx+2)%3]}"/></linearGradient></defs><rect width="600" height="300" fill="url(#g)"/><text x="300" y="155" text-anchor="middle" font-family="monospace" font-size="10" fill="rgba(255,255,255,0.04)" letter-spacing="8">${(region||"NEWS").slice(0,12)}</text></svg>`)}`;
}

function renderTopNews(){
  const items = getTopNewsItems();
  const featured = items[0];
  const side = items.slice(1, 5); // 4 secondary items

  el("topNewsCount").textContent = items.length ? `${items.length} stories across all regions` : "";

  const featuredEl = el("tnFeatured");
  const sideEl = el("tnSideList");

  if (!featured) {
    featuredEl.innerHTML = `<div class="tnFeaturedBody"><div class="text-white/30 text-xs mono tracking-wide">Menunggu top news...</div></div>`;
    sideEl.innerHTML = "";
    return;
  }

  // Featured card
  const ft = safeDate(featured.publishedAt);
  const fTime = ft ? relativeTime(ft) : "";
  const fSrc = (featured.sources||[]).map(s => s?.name).filter(Boolean).slice(0,1).join("");
  const fLede = (() => {
    // Use story excerpt or keypoints as description
    const story = stripHtml(featured.story || "");
    if (story.length >= 60) return story.split(/[.!?]\s/).slice(0, 2).join(". ").slice(0, 200) + (story.length > 200 ? "..." : "");
    if (featured.keypoints?.length) return featured.keypoints.slice(0, 2).join(" — ");
    return "";
  })();
  const fImp = String(featured.impact||"MEDIUM").toUpperCase();
  const fImpCls = fImp==="HIGH" ? "impactHigh" : fImp==="LOW" ? "impactLow" : "impactMed";
  const fImg = topNewsImage(featured.headline, featured.region);

  featuredEl.onclick = () => openNews(featured);
  featuredEl.innerHTML = `
    <img class="tnFeaturedImg" src="${fImg}" alt="" loading="lazy">
    <div class="tnFeaturedBody">
      <div class="flex items-center gap-2">
        <span class="tnRegion ${esc(featured.region)}">${esc(featured.region)}</span>
        <span class="impactTag ${fImpCls}" style="font-size:.46rem">${esc(fImp)}</span>
      </div>
      <div class="tnHeadlineLg">${esc(featured.headline)}</div>
      ${fLede ? `<div class="tnLede">${esc(fLede)}</div>` : ""}
      <div class="tnMeta">
        <span>${esc(fTime)}</span>
        ${fSrc ? `<span style="color:var(--line)">|</span><span>${esc(fSrc)}</span>` : ""}
      </div>
    </div>
  `;

  // Side cards
  sideEl.innerHTML = "";
  side.forEach(it => {
    const t = safeDate(it.publishedAt);
    const timeTxt = t ? relativeTime(t) : "";
    const src = (it.sources||[]).map(s => s?.name).filter(Boolean).slice(0,1).join("");
    const imp = String(it.impact||"MEDIUM").toUpperCase();
    const impCls = imp==="HIGH" ? "impactHigh" : imp==="LOW" ? "impactLow" : "impactMed";
    const card = document.createElement("div");
    card.className = "tnCard";
    card.innerHTML = `
      <div class="flex items-center gap-2">
        <span class="tnRegion ${esc(it.region)}">${esc(it.region)}</span>
        <span class="impactTag ${impCls}" style="font-size:.42rem">${esc(imp)}</span>
      </div>
      <div class="tnHeadlineSm">${esc(it.headline)}</div>
      <div class="tnCardMeta">
        <span>${esc(timeTxt)}</span>
        ${src ? `<span style="color:rgba(255,255,255,.08)">|</span><span>${esc(src)}</span>` : ""}
      </div>
    `;
    card.onclick = () => openNews(it);
    sideEl.appendChild(card);
  });
}

function renderFilterBar(){
  const regionPills = el("regionPills");
  const sectorPills = el("sectorPills");

  regionPills.innerHTML = REGIONS.map(r =>
    `<button class="filterPill${state.region===r?' active':''}" data-region="${esc(r)}">${esc(REGION_META[r].label)}</button>`
  ).join("");

  sectorPills.innerHTML = SECTORS.map(s =>
    `<button class="filterPill${state.sector===s?' active':''}" data-sector="${esc(s)}">${esc(SECTOR_META[s])}</button>`
  ).join("");

  // Event delegation
  regionPills.onclick = (e) => {
    const pill = e.target.closest(".filterPill");
    if (!pill) return;
    state.region = pill.dataset.region;
    renderAll();
  };
  sectorPills.onclick = (e) => {
    const pill = e.target.closest(".filterPill");
    if (!pill) return;
    state.sector = pill.dataset.sector;
    renderAll();
  };
}

function renderAll(){
  renderTopNews();
  renderFilterBar();
  renderNav();
  renderBrief();
  renderMacro();
  renderIndicators();
  renderHeadlines();
  renderWire();
  renderTicker();

  // Update region path bar
  el("regionPathRegion").textContent = REGION_META[state.region]?.label?.toUpperCase() || state.region;
  el("regionPathSector").textContent = SECTOR_META[state.sector] || state.sector;

  // Update timestamps
  const gen = safeDate(state.data?.generatedAt);
  el("lastUpdated").textContent = gen ? gen.toLocaleTimeString("id-ID",{hour:"2-digit",minute:"2-digit"}) : "—";
  el("statusTime").textContent = new Date().toLocaleTimeString("id-ID",{hour:"2-digit",minute:"2-digit",second:"2-digit"});
}

function formatStoryHtml(raw) {
  // 1. Strip HTML and normalize whitespace
  let text = stripHtml(raw || "");
  // 2. Cap at 200 words
  const words = text.split(/\s+/).filter(Boolean);
  if (words.length > 200) text = words.slice(0, 200).join(" ") + "...";
  // 3. Split into sentences
  const sentences = text.match(/[^.!?]+[.!?]+/g) || [text];
  // 4. Group into paragraphs of 5 sentences each
  const paragraphs = [];
  for (let i = 0; i < sentences.length; i += 5) {
    paragraphs.push(sentences.slice(i, i + 5).join(" ").trim());
  }
  // 5. Return justified HTML paragraphs
  return paragraphs.map(p =>
    `<p style="text-align:justify;text-justify:inter-word;margin-bottom:.8rem;line-height:1.75;font-size:.88rem;color:rgba(255,255,255,.72);font-family:Georgia,serif">${esc(p)}</p>`
  ).join("");
}

// ===== Modal =====
const modal = {
  backdrop: el("modalBackdrop"),
  body: el("modalBody"),
  kicker: el("modalKicker"),
  headerRight: el("modalHeaderRight"),
  closeBtn: el("modalCloseBtn"),
};

function showModal(){ modal.backdrop.classList.add("show"); }
function hideModal(){ modal.backdrop.classList.remove("show"); }

function openBrief(region){
  const brief = state.data?.morningBriefs?.[region];
  if (!brief || !Array.isArray(brief.slides) || !brief.slides.length) return;
  state.open = { type:"brief", region };
  renderModal();
}

function openNews(item){
  state.open = { type:"news", item };
  renderModal();
}

function closeModal(){
  state.open = null;
  hideModal();
  modal.body.innerHTML = "";
  modal.kicker.textContent = "";
  modal.headerRight.innerHTML = "";
}

modal.closeBtn.onclick = closeModal;
modal.backdrop.onclick = (e) => { if (e.target === modal.backdrop) closeModal(); };
document.addEventListener("keydown", (e) => { if (e.key === "Escape") closeModal(); });

function renderModal(){
  if (!state.open) return closeModal();
  showModal();

  if (state.open.type === "news"){
    const it = state.open.item;
    const impClass = String(it.impact||"MEDIUM").toUpperCase() === "HIGH" ? "impactHigh" : String(it.impact||"MEDIUM").toUpperCase() === "LOW" ? "impactLow" : "impactMed";
    modal.kicker.innerHTML = `<b>VELRA</b> TERMINAL // INTELLIGENCE`;

    const t = safeDate(it.publishedAt);
    const dateStr = t ? t.toLocaleDateString("id-ID",{day:"numeric",month:"short",year:"numeric"}) : "";

    const srcLink = it.sources?.[0]?.url ? `<a class="text-[var(--gold)] hover:underline font-semibold text-xs" target="_blank" rel="noopener" href="${esc(it.sources[0].url)}">${esc(it.sources[0].name||"Source")}</a>` : "";

    const storyText = stripHtml(it.story || "");
    const headlineNorm = it.headline.toLowerCase().trim();
    const storyNorm = storyText.toLowerCase().trim();
    const hasUniqueStory = storyText && storyNorm !== headlineNorm && storyText.length > headlineNorm.length + 10;

    modal.body.innerHTML = `
      <div class="px-8 py-6">
        <div class="flex items-center gap-3 mb-4">
          <span class="inline-flex items-center gap-1.5 px-2 py-0.5 rounded-sm bg-[rgba(200,169,81,.06)] border border-[rgba(200,169,81,.2)] mono text-[.52rem] tracking-[.12em] font-bold text-[var(--gold)]">VERIFIED WIRE</span>
          ${dateStr ? `<span class="mono text-[.58rem] tracking-[.1em] text-white/35 font-medium">${esc(dateStr)}</span>` : ""}
          <span class="impactTag ${impClass}">${esc(String(it.impact||"MEDIUM").toUpperCase())}</span>
        </div>
        <div class="serifTitle text-[2rem] font-bold leading-[1.1]" style="font-style:italic">${esc(it.headline)}</div>
        <div class="mt-3 flex items-center gap-3">
          <span class="mono text-[.58rem] tracking-[.1em] text-white/40 font-medium">EDITOR: Velra Desk</span>
          <span class="inline-flex items-center gap-1.5 mono text-[.55rem] font-bold text-[var(--green)]"><span class="statusDot" style="width:5px;height:5px"></span> LIVE</span>
          ${srcLink ? `<span class="text-white/20">|</span>${srcLink}` : ""}
        </div>

        ${it.keypoints?.length ? `
          <div class="mt-6 border-l-2 border-[var(--gold)] pl-5">
            <div class="mono text-[.6rem] tracking-[.16em] font-bold text-[var(--gold)] mb-3">KEY TAKEAWAYS</div>
            <div class="space-y-3">
              ${it.keypoints.slice(0,5).map((x,i) => `
                <div class="flex gap-3">
                  <span class="mono text-[.65rem] font-bold text-[var(--gold)] mt-0.5">${String(i+1).padStart(2,"0")}</span>
                  <span class="text-white/75 text-[.88rem] leading-relaxed">${esc(x)}</span>
                </div>
              `).join("")}
            </div>
          </div>` : ``}

        ${hasUniqueStory ? `
          <div class="mt-6 pt-5 border-t border-white/[.06]">
            <div class="mono text-[.6rem] tracking-[.16em] font-bold text-white/35 mb-3">THE STORY</div>
            <div>${formatStoryHtml(storyText)}</div>
          </div>` : ``}
      </div>
    `;
    return;
  }

  if (state.open.type === "brief"){
    const region = state.open.region;
    const brief = state.data?.morningBriefs?.[region];
    modal.kicker.innerHTML = `<b>VELRA</b> MACRO // BRIEFING`;
    modal.headerRight.innerHTML = `<div class="flex items-center gap-2"><span class="mono text-[.55rem] text-white/30">${esc(brief?.asOf || "")}</span><button class="closeBtn" onclick="closeModal()">[ESC] CLOSE</button></div>`;
    if (region === "INDONESIA") {
      modal.body.innerHTML = renderBriefIndonesia(brief);
    } else if (region === "USA") {
      modal.body.innerHTML = renderBriefUSA(brief);
    } else {
      modal.body.innerHTML = renderBriefDeck(brief);
    }
    return;
  }
}

function renderBriefDeck(brief){
  const lede = brief?.lede ? `<div class="mt-4 text-white/65 leading-relaxed text-[.92rem]" style="font-family:Georgia,serif">${esc(brief.lede)}</div>` : "";
  const slides = (brief?.slides || []).map((s, i) => renderSlide(s, i)).join("");
  return `
    <div class="px-8 py-6">
      <div class="flex items-center gap-3 mb-2">
        <span class="mono text-[.58rem] tracking-[.14em] font-bold text-[var(--gold)]">VELRA MACRO</span>
        <span class="statusDot" style="width:5px;height:5px"></span>
      </div>
      <div class="serifTitle text-[2.2rem] font-bold leading-[1.1]" style="font-style:italic">${esc(brief?.title || "Morning Brief")}</div>
      ${lede}
      <div class="mt-6 space-y-5">${slides}</div>
    </div>
  `;
}

function renderSlide(slide, idx){
  const title = esc(slide?.title || "");
  const type = slide?.type;
  const num = String((idx || 0) + 1).padStart(2, "0");

  // helper wrappers
  const wrap = (inner) => `
    <div class="card p-5">
      <div class="flex items-center gap-3 mb-4">
        <span class="mono text-[.7rem] font-bold text-[var(--gold)]">${num}</span>
        <span class="mono text-[.58rem] tracking-[.12em] font-bold text-white/30">//</span>
        <span class="mono text-[.62rem] tracking-[.12em] font-bold text-white/50">${title.toUpperCase()}</span>
      </div>
      <div>${inner}</div>
    </div>
  `;

  if (type === "market_snapshot"){
    const rows = (slide.items || []).map(it => {
      const val = (it.valueFmt || it.value || "—");
      const ch = (typeof it.changePct==="number") ? (it.changePct>=0 ? `+${it.changePct.toFixed(2)}%` : `${it.changePct.toFixed(2)}%`) : "";
      return `
        <div class="flex items-center justify-between py-2 border-b border-white/10">
          <div class="text-white/70 font-semibold">${esc(it.label||"")}</div>
          <div class="text-right">
            <div class="text-white/88 font-bold">${esc(val)}</div>
            ${ch ? `<div class="text-xs text-white/55 font-bold">${esc(ch)}</div>` : ``}
          </div>
        </div>
      `;
    }).join("");

    const flow = slide.flow || null;
    let flowBox = "";
    if (flow) {
      const note = flow.miniNote || flow.indexMove || "";
      const fx = flow.foreignNet?.valueFmt || flow.foreignNet?.value || "—";
      const dx = flow.domesticNet?.valueFmt || flow.domesticNet?.value || "—";
      const topBuys = (flow.topBuys || []).slice(0,5).map(x => `<div class="wireKp">• ${esc(x.ticker || "")} ${esc(x.valueFmt || x.value || "")}</div>`).join("");
      const topSells = (flow.topSells || []).slice(0,5).map(x => `<div class="wireKp">• ${esc(x.ticker || "")} ${esc(x.valueFmt || x.value || "")}</div>`).join("");
      const src = (flow.sources || []).slice(0,3).map(s => s?.url ? `<a class="text-xs text-[var(--gold)] hover:underline" target="_blank" rel="noopener" href="${esc(s.url)}">${esc(s.name||"Source")}</a>` : "").filter(Boolean).join(`<span class="mx-2 opacity-35">•</span>`);
      flowBox = `
        <div class="mt-4 card p-4">
          <div class="mono text-[.55rem] tracking-[.14em] font-bold text-white/30">FLOW</div>
          ${note ? `<div class="mt-2 text-white/80">${esc(note)}</div>` : ``}
          <div class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <div class="mono text-[.55rem] tracking-[.14em] font-bold text-white/30">RINGKAS</div>
              <div class="mt-2 space-y-1">
                <div class="wireKp">• Foreign Net: ${esc(fx)}</div>
                <div class="wireKp">• Domestic Net: ${esc(dx)}</div>
              </div>
            </div>
            <div>
              <div class="mono text-[.55rem] tracking-[.14em] font-bold text-white/30">TOP BUYS / SELLS</div>
              <div class="mt-2 grid grid-cols-1 md:grid-cols-2 gap-3">
                <div>${topBuys || `<div class="text-white/45 text-sm">—</div>`}</div>
                <div>${topSells || `<div class="text-white/45 text-sm">—</div>`}</div>
              </div>
            </div>
          </div>
          ${src ? `<div class="mt-3 pt-3 border-t border-white/10">${src}</div>` : ``}
        </div>`;
    }

    return wrap(`${rows || `<div class="text-white/45">—</div>`}${flowBox}`);
  }

  if (type === "impact_cards"){
    const cards = (slide.cards || []).slice(0,6).map(c => `
      <div class="card p-4">
        <div class="font-bold text-white/88">${esc(c.title || c.headline || "")}</div>
        <div class="mt-2 text-white/75 text-sm leading-relaxed">${esc(c.body || (c.keypoints ? c.keypoints.join(" • ") : ""))}</div>
      </div>
    `).join("");

    return wrap(`
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
        ${cards || `<div class="text-white/45">—</div>`}
      </div>
    `);
  }

  if (type === "news_list"){
    const items = (slide.items || []).slice(0,12).map(it => `
      <div class="card p-4">
        <div class="flex items-center justify-between">
          <div class="mono text-[.55rem] tracking-[.14em] font-bold text-white/30">${esc(it.category || "")}</div>
          <div class="text-xs text-white/45 font-semibold">${safeDate(it.publishedAt)?.toLocaleTimeString("id-ID",{hour:"2-digit",minute:"2-digit"}) || ""}</div>
        </div>
        <div class="mt-2 font-bold text-white/88">${esc(it.headline || "")}</div>
        ${it.keypoints?.length ? `<div class="mt-3 space-y-1">${it.keypoints.slice(0,3).map(x=>`<div class="wireKp">• ${esc(x)}</div>`).join("")}</div>` : ``}
      </div>
    `).join("");

    return wrap(`<div class="space-y-3">${items || `<div class="text-white/45">—</div>`}</div>`);
  }

  if (type === "corporate_actions"){
    const items = (slide.items || []).slice(0,10).map(it => `
      <div class="card p-4">
        <div class="flex items-center justify-between">
          <div class="font-bold text-white/88">${esc(it.ticker||"")}</div>
          <div class="text-xs text-white/55 font-semibold">${esc(it.company||"")}</div>
        </div>
        <div class="mt-2 text-white/80 text-sm leading-relaxed">${esc(it.action || it.summary || "")}</div>
      </div>
    `).join("");

    return wrap(`<div class="space-y-3">${items || `<div class="text-white/45">—</div>`}</div>`);
  }

  if (type === "top_movers"){
    const col = (title, arr, sign) => `
      <div>
        <div class="mono text-[.55rem] tracking-[.14em] font-bold text-white/30">${esc(title)}</div>
        <div class="mt-2 space-y-2">
          ${(arr||[]).slice(0,3).map(it => `
            <div class="card p-4">
              <div class="flex items-center justify-between">
                <div class="font-bold text-white/88">${esc(it.ticker||"")}</div>
                <div class="text-sm font-extrabold text-white/80">${esc(sign)}${esc((it.changePct ?? "—"))}${(typeof it.changePct==="number")?"%":""}</div>
              </div>
              ${it.why ? `<div class="mt-2 text-white/70 text-sm">${esc(it.why)}</div>` : ``}
            </div>
          `).join("")}
        </div>
      </div>
    `;
    return wrap(`
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        ${col("GAINERS", slide.gainers, "+")}
        ${col("LOSERS", slide.losers, "")}
      </div>
    `);
  }

  if (type === "macro_rates_fx"){
    const rows = (slide.items||[]).map(it => `
      <div class="flex items-center justify-between py-2 border-b border-white/10">
        <div class="text-white/70 font-semibold">${esc(it.label||"")}</div>
        <div class="text-white/88 font-bold">${esc(it.valueFmt || it.value || "—")}</div>
      </div>
    `).join("");
    const interp = (slide.interpretation||[]).slice(0,6).map(x=>`<div class="wireKp">• ${esc(x)}</div>`).join("");
    return wrap(`${rows || `<div class="text-white/45">—</div>`}${interp ? `<div class="mt-4 space-y-1">${interp}</div>` : ""}`);
  }

  if (type === "etf_flows"){
    const rows = (arr) => (arr||[]).slice(0,3).map(it=>`
      <div class="flex items-center justify-between py-2 border-b border-white/10">
        <div class="text-white/70 font-semibold">${esc(it.symbol||"")}</div>
        <div class="text-white/88 font-bold">${esc(it.flowUsdFmt || it.flowUsd || "—")}</div>
      </div>
    `).join("");

    return wrap(`
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <div class="mono text-[.55rem] tracking-[.14em] font-bold text-white/30">INFLOWS</div>
          <div class="mt-2">${rows(slide.inflows) || `<div class="text-white/45">—</div>`}</div>
        </div>
        <div>
          <div class="mono text-[.55rem] tracking-[.14em] font-bold text-white/30">OUTFLOWS</div>
          <div class="mt-2">${rows(slide.outflows) || `<div class="text-white/45">—</div>`}</div>
        </div>
      </div>
    `);
  }

  if (type === "sector_cards"){
    const items = (slide.items||[]).slice(0,6).map(it => `
      <div class="card p-4">
        <div class="font-bold text-white/88">${esc(SECTOR_META[it.sector] || it.sector || "")}</div>
        <div class="mt-2 text-white/70 text-sm">${esc(it.note || "")}</div>
      </div>
    `).join("");
    return wrap(`<div class="grid grid-cols-1 md:grid-cols-3 gap-3">${items || `<div class="text-white/45">—</div>`}</div>`);
  }

  if (type === "watchlist_playbook"){
    const wl = (slide.watchlist||[]).slice(0,10).map(it => {
      if (typeof it === "string") return `<div class="wireKp">• ${esc(it)}</div>`;
      return `<div class="wireKp">• ${esc(it.ticker || "")}${it.why ? ` — ${esc(it.why)}` : ""}</div>`;
    }).join("");
    const act = (slide.playbook || slide.actions || []).slice(0,10).map(x => `<div class="wireKp">• ${esc(x)}</div>`).join("");
    const disc = slide.disclaimer ? `<div class="mt-4 text-white/45 text-xs">${esc(slide.disclaimer)}</div>` : "";
    return wrap(`
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <div class="mono text-[.55rem] tracking-[.14em] font-bold text-white/30">WATCHLIST</div>
          <div class="mt-2 space-y-1">${wl || `<div class="text-white/45">—</div>`}</div>
        </div>
        <div>
          <div class="mono text-[.55rem] tracking-[.14em] font-bold text-white/30">PLAYBOOK</div>
          <div class="mt-2 space-y-1">${act || `<div class="text-white/45">—</div>`}</div>
        </div>
      </div>
      ${disc}
    `);
  }

  
  if (type === "deep_dive"){
    const it = slide.item || {};
    const bullets = (it.bullets || []).slice(0,6).map(x=>`<div class="wireKp">• ${esc(x)}</div>`).join("");
    const src = (it.sources||[]).slice(0,1).map(s => s?.url ? `<a class="text-xs text-[var(--gold)] hover:underline" target="_blank" rel="noopener" href="${esc(s.url)}">${esc(s.name||"Source")}</a>` : "").join("");
    return wrap(`
      <div class="card p-4">
        <div class="font-bold text-white/88">${esc(it.headline || "")}</div>
        ${it.body ? `<div class="mt-2 text-white/75 text-sm leading-relaxed">${esc(it.body)}</div>` : ``}
        ${bullets ? `<div class="mt-3 space-y-1">${bullets}</div>` : ``}
        ${src ? `<div class="mt-3">${src}</div>` : ``}
      </div>
    `);
  }

return wrap(`<div class="text-white/60">Slide type tidak didukung: ${esc(type)}</div>`);
}

// -------- INDONESIA MORNING BRIEFING --------
function renderBriefIndonesia(brief){
  const slides = brief?.slides || [];
  const findSlide = (type) => slides.find(s => s?.type === type);

  // Opening paragraph
  const lede = brief?.lede || "";

  // FLOW IHSG section
  const snap = findSlide("market_snapshot");
  const flow = snap?.flow || {};
  const fBuy = flow.foreignBuy || "—";
  const fSell = flow.foreignSell || "—";
  const dBuy = flow.domesticBuy || "—";
  const dSell = flow.domesticSell || "—";
  const fNet = flow.foreignNet?.valueFmt || flow.foreignNet?.value || "—";
  const dNet = flow.domesticNet?.valueFmt || flow.domesticNet?.value || "—";
  const indexNote = flow.miniNote || flow.indexMove || "";
  const topBuys = (flow.topBuys || []).slice(0,3);
  const topSells = (flow.topSells || []).slice(0,3);

  // Helper: horizontal bar (CSS-only)
  function flowBar(label, value, color, maxWidth) {
    const w = maxWidth || "100%";
    return `<div class="flex items-center gap-3 py-1">
      <div class="w-20 text-xs text-white/55 font-semibold text-right">${esc(label)}</div>
      <div class="flex-1 h-5 bg-white/5 rounded overflow-hidden">
        <div class="h-full rounded" style="width:${w};background:${color}"></div>
      </div>
      <div class="w-24 text-xs text-white/70 font-bold text-right">${esc(String(value))}</div>
    </div>`;
  }

  // Helper: ticker row for buy/sell table
  function tickerRow(item, idx) {
    const ticker = item?.ticker || "—";
    const val = item?.valueFmt || item?.value || "—";
    return `<div class="flex items-center gap-3 py-2 border-b border-white/8">
      <div class="w-6 h-6 rounded bg-white/10 flex items-center justify-center text-[.6rem] font-extrabold text-white/50">${idx+1}</div>
      <div class="flex-1">
        <span class="font-bold text-white/88 text-sm">${esc(ticker)}</span>
      </div>
      <div class="text-xs text-white/70 font-semibold">${esc(val)}</div>
    </div>`;
  }

  const flowSection = `
    <div class="card p-5 mt-5">
      <div class="flex items-center gap-3"><span class="mono text-[.7rem] font-bold text-[var(--gold)]">01</span><span class="mono text-[.58rem] tracking-[.12em] font-bold text-white/30">//</span><span class="mono text-[.62rem] tracking-[.12em] font-bold text-white/50">FLOW IHSG</span></div>
      <div class="mt-4 space-y-1">
        ${flowBar("Foreign Buy", fBuy, "rgba(200,169,81,.6)", "65%")}
        ${flowBar("Foreign Sell", fSell, "rgba(239,68,68,.5)", "55%")}
        ${flowBar("Domestic Buy", dBuy, "rgba(200,169,81,.45)", "70%")}
        ${flowBar("Domestic Sell", dSell, "rgba(239,68,68,.35)", "60%")}
      </div>
      <div class="mt-2 grid grid-cols-2 gap-2 text-xs text-white/60">
        <div>Foreign Net: <span class="font-extrabold text-white/80">${esc(fNet)}</span></div>
        <div>Domestic Net: <span class="font-extrabold text-white/80">${esc(dNet)}</span></div>
      </div>
      <div class="mt-5 grid grid-cols-2 gap-5">
        <div>
          <div class="text-xs tracking-[.18em] font-extrabold text-[var(--gold)] mb-2">TOP FOREIGN BUY</div>
          ${topBuys.length ? topBuys.map((x,i) => tickerRow(x,i)).join("") : `<div class="text-white/40 text-sm">—</div>`}
        </div>
        <div>
          <div class="text-xs tracking-[.18em] font-extrabold text-red-400/70 mb-2">TOP FOREIGN SELL</div>
          ${topSells.length ? topSells.map((x,i) => tickerRow(x,i)).join("") : `<div class="text-white/40 text-sm">—</div>`}
        </div>
      </div>
      ${indexNote ? `<div class="mt-4 pt-3 border-t border-white/10 text-sm text-white/70">${esc(indexNote)}</div>` : ""}
    </div>`;

  // Impact events (3 cards)
  const impact = findSlide("impact_cards");
  const impactCards = (impact?.cards || []).slice(0,3);
  const impactSection = impactCards.length ? `
    <div class="mt-6">
      <div class="flex items-center gap-3 mb-4"><span class="mono text-[.7rem] font-bold text-[var(--gold)]">02</span><span class="mono text-[.58rem] tracking-[.12em] font-bold text-white/30">//</span><span class="mono text-[.62rem] tracking-[.12em] font-bold text-white/50">PERISTIWA BERDAMPAK HARI INI</span></div>
      <div class="grid grid-cols-3 gap-3">
        ${impactCards.map(c => `
          <div class="rounded border border-[rgba(201,168,76,.2)] bg-[rgba(201,168,76,.04)] p-4">
            <div class="font-bold text-white/88 text-sm leading-tight">${esc(c.title || c.headline || "")}</div>
            <div class="mt-2 text-white/65 text-xs leading-relaxed">${esc(c.body || "")}</div>
          </div>
        `).join("")}
      </div>
    </div>` : "";

  // Important news (4-5 items as cards)
  const news = findSlide("news_list");
  const newsItems = (news?.items || []).slice(0,5);
  const newsSection = newsItems.length ? `
    <div class="mt-6">
      <div class="flex items-center gap-3 mb-4"><span class="mono text-[.7rem] font-bold text-[var(--gold)]">03</span><span class="mono text-[.58rem] tracking-[.12em] font-bold text-white/30">//</span><span class="mono text-[.62rem] tracking-[.12em] font-bold text-white/50">BERITA PENTING INDONESIA</span></div>
      <div class="space-y-3">
        ${newsItems.map(it => `
          <div class="card p-4">
            <div class="font-bold text-white/88 text-sm">${esc(it.headline || "")}</div>
            ${it.keypoints?.length ? `<div class="mt-2 text-white/60 text-xs leading-relaxed">${esc(it.keypoints.slice(0,2).join(" • "))}</div>` : ""}
          </div>
        `).join("")}
      </div>
    </div>` : "";

  // Corporate Actions + Top Movers LQ45 (merged)
  const corp = findSlide("corporate_actions");
  const movers = findSlide("top_movers");
  const corpItems = (corp?.items || []).slice(0,4);
  const gainers = (movers?.gainers || []).slice(0,3);
  const losers = (movers?.losers || []).slice(0,3);

  const corpMoversSection = (corpItems.length || gainers.length || losers.length) ? `
    <div class="mt-6">
      <div class="flex items-center gap-3 mb-4"><span class="mono text-[.7rem] font-bold text-[var(--gold)]">04</span><span class="mono text-[.58rem] tracking-[.12em] font-bold text-white/30">//</span><span class="mono text-[.62rem] tracking-[.12em] font-bold text-white/50">CORPORATE ACTION & TOP MOVERS LQ45</span></div>
      ${corpItems.length ? `
        <div class="grid grid-cols-2 gap-3 mb-4">
          ${corpItems.map(it => `
            <div class="card p-4 flex items-start gap-3">
              <div class="w-9 h-9 rounded bg-[rgba(201,168,76,.12)] flex items-center justify-center text-xs font-extrabold text-[var(--gold)]">${esc((it.ticker||"").slice(0,4))}</div>
              <div class="flex-1 min-w-0">
                <div class="font-bold text-white/88 text-sm">${esc(it.ticker || "")}</div>
                <div class="text-white/60 text-xs mt-1 leading-relaxed">${esc(it.action || it.summary || "")}</div>
              </div>
            </div>
          `).join("")}
        </div>` : ""}
      ${(gainers.length || losers.length) ? `
        <div class="grid grid-cols-2 gap-5">
          <div>
            <div class="text-xs tracking-[.18em] font-extrabold text-green-400/80 mb-2">TOP GAINER LQ45</div>
            ${gainers.map(it => `
              <div class="flex items-center gap-3 py-2 border-b border-white/8">
                <div class="w-8 h-8 rounded bg-green-400/10 flex items-center justify-center text-[.6rem] font-extrabold text-green-400/70">${esc((it.ticker||"").slice(0,4))}</div>
                <div class="flex-1"><span class="font-bold text-white/88 text-sm">${esc(it.ticker||"")}</span></div>
                <div class="text-green-400 text-xs font-extrabold">+${esc(String(it.changePct ?? "—"))}%</div>
              </div>
              ${it.why ? `<div class="text-white/50 text-xs ml-11 mb-1">${esc(it.why)}</div>` : ""}
            `).join("")}
          </div>
          <div>
            <div class="text-xs tracking-[.18em] font-extrabold text-red-400/80 mb-2">TOP LOSER LQ45</div>
            ${losers.map(it => `
              <div class="flex items-center gap-3 py-2 border-b border-white/8">
                <div class="w-8 h-8 rounded bg-red-400/10 flex items-center justify-center text-[.6rem] font-extrabold text-red-400/70">${esc((it.ticker||"").slice(0,4))}</div>
                <div class="flex-1"><span class="font-bold text-white/88 text-sm">${esc(it.ticker||"")}</span></div>
                <div class="text-red-400 text-xs font-extrabold">${esc(String(it.changePct ?? "—"))}%</div>
              </div>
              ${it.why ? `<div class="text-white/50 text-xs ml-11 mb-1">${esc(it.why)}</div>` : ""}
            `).join("")}
          </div>
        </div>` : ""}
    </div>` : "";

  // Watchlist & Recommendations
  const wp = findSlide("watchlist_playbook");
  const watchlist = (wp?.watchlist || []).slice(0,6);
  const playbook = (wp?.playbook || wp?.actions || []).slice(0,4);
  const watchSection = `
    <div class="card p-5 mt-6">
      <div class="flex items-center gap-3 mb-4"><span class="mono text-[.7rem] font-bold text-[var(--gold)]">05</span><span class="mono text-[.58rem] tracking-[.12em] font-bold text-white/30">//</span><span class="mono text-[.62rem] tracking-[.12em] font-bold text-white/50">WATCHLIST & REKOMENDASI</span></div>
      <div class="grid grid-cols-2 gap-5">
        <div>
          <div class="mono text-[.55rem] tracking-[.14em] font-bold text-white/30 mb-2">WATCHLIST</div>
          ${watchlist.map(it => {
            const t = typeof it === "string" ? it : it.ticker || "";
            const w = typeof it === "string" ? "" : it.why || "";
            return `<div class="py-2 border-b border-white/8">
              <span class="font-bold text-white/88 text-sm">${esc(t)}</span>
              ${w ? `<span class="text-white/50 text-xs ml-2">${esc(w)}</span>` : ""}
            </div>`;
          }).join("")}
        </div>
        <div>
          <div class="mono text-[.55rem] tracking-[.14em] font-bold text-white/30 mb-2">TINDAKAN</div>
          <div class="space-y-2">
            ${playbook.map(x => `<div class="text-white/75 text-sm leading-relaxed">• ${esc(typeof x === "string" ? x : x.text || "")}</div>`).join("")}
          </div>
        </div>
      </div>
      <div class="mt-4 pt-3 border-t border-white/10 text-white/30 text-[.65rem] tracking-wide">DISCLAIMER: Bukan nasihat keuangan. Lakukan riset mandiri sebelum mengambil keputusan investasi.</div>
    </div>`;

  return `
    <div class="px-8 py-6">
      <div>
        <div class="flex items-center gap-3 mb-2">
          <span class="mono text-[.58rem] tracking-[.14em] font-bold text-[var(--gold)]">VELRA MACRO</span>
          <span class="statusDot" style="width:5px;height:5px"></span>
        </div>
        <div class="serifTitle text-[2.2rem] font-bold leading-[1.1]" style="font-style:italic">${esc(brief?.title || "Indonesia Morning Briefing")}</div>
        ${lede ? `<div class="mt-3 text-white/65 leading-relaxed text-[.92rem]" style="font-family:Georgia,serif">${esc(lede)}</div>` : ""}
      </div>
      ${flowSection}
      ${impactSection}
      ${newsSection}
      ${corpMoversSection}
      ${watchSection}
    </div>
  `;
}

// -------- USA MORNING BRIEFING --------
function renderBriefUSA(brief){
  const slides = brief?.slides || [];
  const findSlide = (type) => slides.find(s => s?.type === type);

  const lede = brief?.lede || "";

  // Market Snapshot cards
  const snap = findSlide("market_snapshot");
  const snapItems = (snap?.items || []).slice(0,6);
  const snapSection = snapItems.length ? `
    <div class="mt-5">
      <div class="flex items-center gap-3 mb-4"><span class="mono text-[.7rem] font-bold text-[var(--gold)]">01</span><span class="mono text-[.58rem] tracking-[.12em] font-bold text-white/30">//</span><span class="mono text-[.62rem] tracking-[.12em] font-bold text-white/50">MARKET SNAPSHOT</span></div>
      <div class="grid grid-cols-5 gap-3">
        ${snapItems.map(it => {
          const ch = typeof it.changePct === "number" ? it.changePct : null;
          const chTxt = ch === null ? "" : (ch >= 0 ? `+${ch.toFixed(2)}%` : `${ch.toFixed(2)}%`);
          const chColor = ch === null ? "text-white/55" : (ch >= 0 ? "text-green-400" : "text-red-400");
          return `
            <div class="card p-3 text-center">
              <div class="text-xs text-white/50 font-semibold">${esc(it.note || it.label || "")}</div>
              <div class="text-white/88 font-bold mt-1">${esc(it.valueFmt || it.value || "—")}</div>
              ${chTxt ? `<div class="${chColor} text-xs font-extrabold mt-1">${esc(chTxt)}</div>` : ""}
            </div>`;
        }).join("")}
      </div>
    </div>` : "";

  // Global impact events (3 cards)
  const impact = findSlide("impact_cards");
  const impactCards = (impact?.cards || []).slice(0,3);
  const impactSection = impactCards.length ? `
    <div class="mt-6">
      <div class="flex items-center gap-3 mb-4"><span class="mono text-[.7rem] font-bold text-[var(--gold)]">02</span><span class="mono text-[.58rem] tracking-[.12em] font-bold text-white/30">//</span><span class="mono text-[.62rem] tracking-[.12em] font-bold text-white/50">GLOBAL EVENTS IMPACTING MARKETS</span></div>
      <div class="grid grid-cols-3 gap-3">
        ${impactCards.map(c => `
          <div class="rounded border border-[rgba(201,168,76,.2)] bg-[rgba(201,168,76,.04)] p-4">
            <div class="font-bold text-white/88 text-sm leading-tight">${esc(c.title || c.headline || "")}</div>
            <div class="mt-2 text-white/65 text-xs leading-relaxed">${esc(c.body || "")}</div>
          </div>
        `).join("")}
      </div>
    </div>` : "";

  // Corporate news (4-5 cards)
  const news = findSlide("news_list");
  const newsItems = (news?.items || []).slice(0,5);
  const newsSection = newsItems.length ? `
    <div class="mt-6">
      <div class="flex items-center gap-3 mb-4"><span class="mono text-[.7rem] font-bold text-[var(--gold)]">03</span><span class="mono text-[.58rem] tracking-[.12em] font-bold text-white/30">//</span><span class="mono text-[.62rem] tracking-[.12em] font-bold text-white/50">CORPORATE & KEY NEWS</span></div>
      <div class="space-y-3">
        ${newsItems.map(it => `
          <div class="card p-4">
            <div class="font-bold text-white/88 text-sm">${esc(it.headline || "")}</div>
            ${it.keypoints?.length ? `<div class="mt-2 text-white/60 text-xs leading-relaxed">${esc(it.keypoints.slice(0,2).join(" • "))}</div>` : ""}
          </div>
        `).join("")}
      </div>
    </div>` : "";

  // Market conditions (key indicators + flows)
  const rates = findSlide("macro_rates_fx");
  const rateItems = (rates?.items || []).slice(0,4);
  const etfSlide = findSlide("etf_flows");
  const inflows = (etfSlide?.inflows || []).slice(0,3);
  const outflows = (etfSlide?.outflows || []).slice(0,3);

  function etfBar(items, label, color) {
    if (!items.length) return `<div class="text-white/40 text-sm">Data belum tersedia</div>`;
    return items.map(it => `
      <div class="flex items-center gap-3 py-2 border-b border-white/8">
        <div class="w-16 text-xs font-extrabold text-white/80">${esc(it.symbol || it.ticker || "")}</div>
        <div class="flex-1 h-4 bg-white/5 rounded overflow-hidden">
          <div class="h-full rounded" style="width:${Math.min(100, Math.abs(it.pct || 50))}%;background:${color}"></div>
        </div>
        <div class="w-20 text-xs text-white/70 font-semibold text-right">${esc(it.flowUsdFmt || it.flowUsd || "—")}</div>
      </div>
    `).join("");
  }

  const conditionSection = (rateItems.length || inflows.length || outflows.length) ? `
    <div class="mt-6">
      <div class="flex items-center gap-3 mb-4"><span class="mono text-[.7rem] font-bold text-[var(--gold)]">04</span><span class="mono text-[.58rem] tracking-[.12em] font-bold text-white/30">//</span><span class="mono text-[.62rem] tracking-[.12em] font-bold text-white/50">MARKET CONDITIONS & FLOWS</span></div>
      ${rateItems.length ? `
        <div class="grid grid-cols-4 gap-3 mb-5">
          ${rateItems.map(it => `
            <div class="card p-3 text-center">
              <div class="text-xs text-white/50 font-semibold">${esc(it.label || "")}</div>
              <div class="text-white/88 font-bold mt-1">${esc(it.valueFmt || it.value || "—")}</div>
              ${it.note ? `<div class="text-white/50 text-[.65rem] mt-1">${esc(it.note)}</div>` : ""}
            </div>
          `).join("")}
        </div>` : ""}
      ${(inflows.length || outflows.length) ? `
        <div class="card p-4">
          <div class="mono text-[.55rem] tracking-[.14em] font-bold text-white/30 mb-3">ETF FLOWS</div>
          <div class="grid grid-cols-2 gap-5">
            <div>
              <div class="text-xs font-extrabold text-green-400/70 mb-2">TOP INFLOWS</div>
              ${etfBar(inflows, "INFLOWS", "rgba(74,222,128,.6)")}
            </div>
            <div>
              <div class="text-xs font-extrabold text-red-400/70 mb-2">TOP OUTFLOWS</div>
              ${etfBar(outflows, "OUTFLOWS", "rgba(248,113,113,.6)")}
            </div>
          </div>
        </div>` : ""}
    </div>` : "";

  // Sector summary (6 cards in 3x2 grid)
  const sectorSlide = findSlide("sector_cards");
  const sectorItems = (sectorSlide?.items || []).slice(0,6);
  const sectorSection = sectorItems.length ? `
    <div class="mt-6">
      <div class="flex items-center gap-3 mb-4"><span class="mono text-[.7rem] font-bold text-[var(--gold)]">05</span><span class="mono text-[.58rem] tracking-[.12em] font-bold text-white/30">//</span><span class="mono text-[.62rem] tracking-[.12em] font-bold text-white/50">SECTOR OVERVIEW</span></div>
      <div class="grid grid-cols-3 gap-3">
        ${sectorItems.map(it => `
          <div class="card p-4">
            <div class="font-extrabold text-[var(--gold)] text-xs tracking-wider mb-2">${esc(SECTOR_META[it.sector] || it.sector || "")}</div>
            <div class="space-y-1">
              ${(it.keypoints || []).slice(0,3).map(kp => `<div class="text-white/65 text-xs leading-relaxed">• ${esc(kp)}</div>`).join("")}
            </div>
          </div>
        `).join("")}
      </div>
    </div>` : "";

  // Watchlist & Recommendations
  const wp = findSlide("watchlist_playbook");
  const watchlist = (wp?.watchlist || []).slice(0,6);
  const playbook = (wp?.playbook || wp?.actions || []).slice(0,4);
  const watchSection = `
    <div class="card p-5 mt-6">
      <div class="flex items-center gap-3 mb-4"><span class="mono text-[.7rem] font-bold text-[var(--gold)]">06</span><span class="mono text-[.58rem] tracking-[.12em] font-bold text-white/30">//</span><span class="mono text-[.62rem] tracking-[.12em] font-bold text-white/50">WATCHLIST & RECOMMENDED ACTIONS</span></div>
      <div class="grid grid-cols-2 gap-5">
        <div>
          <div class="mono text-[.55rem] tracking-[.14em] font-bold text-white/30 mb-2">WATCHLIST</div>
          ${watchlist.map(it => {
            const t = typeof it === "string" ? it : it.ticker || "";
            const w = typeof it === "string" ? "" : it.why || "";
            return `<div class="py-2 border-b border-white/8">
              <span class="font-bold text-white/88 text-sm">${esc(t)}</span>
              ${w ? `<span class="text-white/50 text-xs ml-2">${esc(w)}</span>` : ""}
            </div>`;
          }).join("")}
        </div>
        <div>
          <div class="mono text-[.55rem] tracking-[.14em] font-bold text-white/30 mb-2">ACTIONS</div>
          <div class="space-y-2">
            ${playbook.map(x => `<div class="text-white/75 text-sm leading-relaxed">• ${esc(typeof x === "string" ? x : x.text || "")}</div>`).join("")}
          </div>
        </div>
      </div>
      <div class="mt-4 pt-3 border-t border-white/10 text-white/30 text-[.65rem] tracking-wide">DISCLAIMER: Not financial advice. Do your own research before making investment decisions.</div>
    </div>`;

  return `
    <div class="px-8 py-6">
      <div>
        <div class="flex items-center gap-3 mb-2">
          <span class="mono text-[.58rem] tracking-[.14em] font-bold text-[var(--gold)]">VELRA MACRO</span>
          <span class="statusDot" style="width:5px;height:5px"></span>
        </div>
        <div class="serifTitle text-[2.2rem] font-bold leading-[1.1]" style="font-style:italic">${esc(brief?.title || "US Pre-Market Brief")}</div>
        ${lede ? `<div class="mt-3 text-white/65 leading-relaxed text-[.92rem]" style="font-family:Georgia,serif">${esc(lede)}</div>` : ""}
      </div>
      ${snapSection}
      ${impactSection}
      ${newsSection}
      ${conditionSection}
      ${sectorSection}
      ${watchSection}
    </div>
  `;
}

async function boot(){
  try{
    await fetchData();
    renderAll();

    // Show status warning if data is stale or empty
    const status = state.data?.status;
    if (status && !status.ok) {
      console.warn("[VELRA] Data status not ok:", status.last_error || status.note);
    }

    // Auto-refresh every 5 minutes
    setInterval(async () => {
      try { await fetchData(); renderAll(); } catch(e) { console.warn("[VELRA] Auto-refresh failed:", e); }
    }, 5 * 60 * 1000);

  }catch(e){
    console.error(e);
    el("wireEmpty").classList.remove("hidden");
    el("wireEmpty").textContent = "Gagal memuat data. Pastikan worker sudah berjalan dan GCS_BUCKET tersedia.";
  }
}

el("btnReconnect").onclick = async () => {
  try { await fetchData(); renderAll(); } catch(e) { console.error(e); }
};

boot();
</script>

</body>
</html>
